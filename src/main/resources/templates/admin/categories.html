<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">

<head>
  <title>카테고리 관리 - PeakMeShop 관리자</title>
  <meta name="description" content="PeakMeShop 관리자 카테고리 관리 페이지">
  <style>
    .category-tree-item {
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 4px;
      cursor: pointer;
    }

    .category-tree-item:hover {
      background-color: #f8f9fa;
    }

    .category-tree-item.active {
      background-color: #e9ecef;
    }

    .category-tree-item .badge {
      font-size: 0.7em;
    }

    .category-actions {
      visibility: hidden;
    }

    .category-tree-item:hover .category-actions {
      visibility: visible;
    }

    .sortable-ghost {
      background-color: #e9ecef;
      border: 1px dashed #6c757d;
    }

    .drag-handle {
      cursor: grab;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    .category-image-preview {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }

    .category-status-badge {
      font-size: 0.75em;
      padding: 0.25em 0.6em;
    }
  </style>
</head>

<body>
<div layout:fragment="content">
  <div class="container-fluid px-4">
    <h1 class="mt-4">카테고리 관리</h1>
    <ol class="breadcrumb mb-4">
      <li class="breadcrumb-item"><a href="/admin">대시보드</a></li>
      <li class="breadcrumb-item active">카테고리 관리</li>
    </ol>

    <div class="row">
      <!-- 카테고리 트리 영역 -->
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-sitemap me-1"></i>
              카테고리 구조
            </div>
            <div>
              <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                      data-bs-target="#addCategoryModal">
                <i class="fas fa-plus"></i> 카테고리 추가
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div class="input-group">
                <input type="text" class="form-control" id="categorySearch" placeholder="카테고리 검색...">
                <button class="btn btn-outline-secondary" type="button" id="searchCategoryBtn">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>

            <div class="mb-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="showInactiveCategories" value="1">
                <label class="form-check-label" for="showInactiveCategories">비활성 카테고리 표시</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="showFeaturedOnly" value="1">
                <label class="form-check-label" for="showFeaturedOnly">추천 카테고리만 표시</label>
              </div>
            </div>

            <div id="categoryTree" class="mt-3">
              <!-- 카테고리 트리 구조가 여기에 동적으로 로드됩니다 -->
              <div class="text-center py-5" id="categoryTreeLoading">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">로딩 중...</span>
                </div>
                <p class="mt-2">카테고리 로딩 중...</p>
              </div>
              <div id="categoryTreeContent" class="d-none">
                <!-- 카테고리 트리 내용이 여기에 표시됩니다 -->
              </div>
              <div id="noCategoriesMessage" class="text-center py-5 d-none">
                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <p>등록된 카테고리가 없습니다.</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#addCategoryModal">
                  <i class="fas fa-plus"></i> 첫 카테고리 추가하기
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 카테고리 상세 정보 영역 -->
      <div class="col-md-8">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-info-circle me-1"></i>
              카테고리 상세 정보
            </div>
            <div id="categoryDetailActions" class="d-none">
              <button type="button" class="btn btn-sm btn-success me-2" id="saveCategoryBtn">
                <i class="fas fa-save"></i> 저장
              </button>
              <button type="button" class="btn btn-sm btn-danger" id="deleteCategoryBtn">
                <i class="fas fa-trash"></i> 삭제
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="categoryDetailLoading" class="text-center py-5 d-none">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">로딩 중...</span>
              </div>
              <p class="mt-2">카테고리 정보 로딩 중...</p>
            </div>

            <div id="noCategorySelected" class="text-center py-5">
              <i class="fas fa-hand-pointer fa-3x text-muted mb-3"></i>
              <p>왼쪽에서 카테고리를 선택하거나 새 카테고리를 추가하세요.</p>
            </div>

            <form id="categoryDetailForm" class="d-none">
              <input type="hidden" id="categoryId">

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="categoryName" class="form-label">카테고리명 <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="categoryName" required>
                </div>
                <div class="col-md-6">
                  <label for="categorySlug" class="form-label">슬러그 <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="categorySlug" required>
                  <small class="form-text text-muted">URL에 사용될 고유 식별자입니다. 영문, 숫자, 하이픈만 사용 가능합니다.</small>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="categoryParent" class="form-label">상위 카테고리</label>
                  <select class="form-select" id="categoryParent">
                    <option value="">없음 (최상위 카테고리)</option>
                    <!-- 상위 카테고리 옵션이 여기에 동적으로 로드됩니다 -->
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="categorySortOrder" class="form-label">정렬 순서</label>
                  <input type="number" class="form-control" id="categorySortOrder" min="0" value="0">
                  <small class="form-text text-muted">낮은 숫자가 먼저 표시됩니다.</small>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="categoryActive" checked>
                    <label class="form-check-label" for="categoryActive">활성화</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="categoryFeatured">
                    <label class="form-check-label" for="categoryFeatured">추천 카테고리</label>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="categoryDescription" class="form-label">설명</label>
                <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
              </div>

              <div class="mb-3">
                <label for="categoryImage" class="form-label">카테고리 이미지</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="categoryImageUrl" placeholder="이미지 URL">
                  <button class="btn btn-outline-secondary" type="button" id="uploadImageBtn">
                    <i class="fas fa-upload"></i> 업로드
                  </button>
                </div>
                <div class="mt-2" id="categoryImagePreviewContainer">
                  <img src="/placeholder.svg?height=60&width=60" id="categoryImagePreview" class="category-image-preview d-none" alt="카테고리 이미지 미리보기">
                </div>
              </div>

              <div class="mb-3">
                <label for="filterableAttributes" class="form-label">필터링 가능한 속성</label>
                <select class="form-select" id="filterableAttributes" multiple>
                  <option value="color">색상</option>
                  <option value="size">사이즈</option>
                  <option value="material">소재</option>
                  <option value="brand">브랜드</option>
                  <option value="price">가격</option>
                  <!-- 추가 속성들이 여기에 동적으로 로드될 수 있습니다 -->
                </select>
                <small class="form-text text-muted">이 카테고리에서 필터링 가능한 상품 속성을 선택하세요. (Ctrl 키를 누른 상태에서 여러 항목 선택 가능)</small>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <p class="mb-1"><small>생성일:</small></p>
                  <p id="categoryCreatedAt">-</p>
                </div>
                <div class="col-md-6">
                  <p class="mb-1"><small>최종 수정일:</small></p>
                  <p id="categoryUpdatedAt">-</p>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 추천 카테고리 섹션 -->
    <div class="card mb-4">
      <div class="card-header">
        <i class="fas fa-star me-1"></i>
        추천 카테고리
      </div>
      <div class="card-body">
        <div class="row" id="featuredCategoriesContainer">
          <!-- 추천 카테고리가 여기에 동적으로 로드됩니다 -->
          <div class="text-center py-5" id="featuredCategoriesLoading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">로딩 중...</span>
            </div>
            <p class="mt-2">추천 카테고리 로딩 중...</p>
          </div>
          <div id="noFeaturedCategoriesMessage" class="text-center py-5 d-none">
            <i class="fas fa-star fa-3x text-muted mb-3"></i>
            <p>추천 카테고리가 없습니다. 카테고리 상세 정보에서 '추천 카테고리' 옵션을 활성화하세요.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 카테고리 추가 모달 -->
  <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCategoryModalLabel">새 카테고리 추가</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addCategoryForm">
            <div class="mb-3">
              <label for="newCategoryName" class="form-label">카테고리명 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="newCategoryName" required>
            </div>
            <div class="mb-3">
              <label for="newCategorySlug" class="form-label">슬러그 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="newCategorySlug" required>
              <small class="form-text text-muted">URL에 사용될 고유 식별자입니다. 영문, 숫자, 하이픈만 사용 가능합니다.</small>
            </div>
            <div class="mb-3">
              <label for="newCategoryParent" class="form-label">상위 카테고리</label>
              <select class="form-select" id="newCategoryParent">
                <option value="">없음 (최상위 카테고리)</option>
                <!-- 상위 카테고리 옵션이 여기에 동적으로 로드됩니다 -->
              </select>
            </div>
            <div class="mb-3">
              <label for="newCategoryDescription" class="form-label">설명</label>
              <textarea class="form-control" id="newCategoryDescription" rows="3"></textarea>
            </div>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="newCategoryActive" checked>
              <label class="form-check-label" for="newCategoryActive">활성화</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" id="addCategoryBtn">추가</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 카테고리 삭제 확인 모달 -->
  <div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteCategoryModalLabel">카테고리 삭제 확인</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>정말로 <strong id="deleteCategoryName"></strong> 카테고리를 삭제하시겠습니까?</p>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="deleteCategoryWarning">이 카테고리에 속한 모든 상품은 카테고리가 없는 상태가 됩니다.</span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteCategoryBtn">삭제</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 이미지 업로드 모달 -->
  <div class="modal fade" id="uploadImageModal" tabindex="-1" aria-labelledby="uploadImageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadImageModalLabel">카테고리 이미지 업로드</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="uploadImageForm">
            <div class="mb-3">
              <label for="categoryImageFile" class="form-label">이미지 파일 선택</label>
              <input class="form-control" type="file" id="categoryImageFile" accept="image/*">
              <small class="form-text text-muted">권장 크기: 500x500px, 최대 파일 크기: 2MB</small>
            </div>
            <div class="mb-3">
              <label class="form-label">미리보기</label>
              <div class="text-center p-3 bg-light rounded">
                <img id="uploadImagePreview" src="/placeholder.svg?height=200&width=200" class="img-fluid" style="max-height: 200px;" alt="이미지 미리보기">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" id="confirmUploadImageBtn">업로드</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript 코드 -->
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      // 전역 변수
      let allCategories = [];
      let currentCategoryId = null;
      let parentCategoryOptions = [];

      // 초기 데이터 로드
      loadAllCategories();
      loadFeaturedCategories();

      // 카테고리 전체 목록 로드
      function loadAllCategories() {
        fetch('/api/categories/all')
                .then(response => {
                  if (!response.ok) {
                    throw new Error('카테고리 목록을 불러오는데 실패했습니다.');
                  }
                  return response.json();
                })
                .then(data => {
                  allCategories = data;
                  renderCategoryTree();
                  populateParentCategoryOptions();
                })
                .catch(error => {
                  console.error('Error:', error);
                  showToast('오류', '카테고리 목록을 불러오는데 실패했습니다.', 'error');
                })
                .finally(() => {
                  document.getElementById('categoryTreeLoading').classList.add('d-none');
                  if (allCategories.length === 0) {
                    document.getElementById('noCategoriesMessage').classList.remove('d-none');
                  } else {
                    document.getElementById('categoryTreeContent').classList.remove('d-none');
                  }
                });
      }

      // 추천 카테고리 로드
      function loadFeaturedCategories() {
        fetch('/api/categories/featured')
                .then(response => {
                  if (!response.ok) {
                    throw new Error('추천 카테고리를 불러오는데 실패했습니다.');
                  }
                  return response.json();
                })
                .then(data => {
                  renderFeaturedCategories(data);
                })
                .catch(error => {
                  console.error('Error:', error);
                  showToast('오류', '추천 카테고리를 불러오는데 실패했습니다.', 'error');
                })
                .finally(() => {
                  document.getElementById('featuredCategoriesLoading').classList.add('d-none');
                });
      }

      // 카테고리 트리 렌더링
      function renderCategoryTree() {
        const treeContainer = document.getElementById('categoryTreeContent');
        treeContainer.innerHTML = '';

        // 필터 적용
        const showInactive = document.getElementById('showInactiveCategories').checked;
        const showFeaturedOnly = document.getElementById('showFeaturedOnly').checked;
        const searchTerm = document.getElementById('categorySearch').value.toLowerCase();

        // 루트 카테고리 필터링
        const rootCategories = allCategories.filter(category => {
          const matchesSearch = searchTerm === '' ||
                  category.name.toLowerCase().includes(searchTerm) ||
                  (category.description && category.description.toLowerCase().includes(searchTerm));
          const matchesStatus = showInactive || category.active;
          const matchesFeatured = !showFeaturedOnly || category.featured;
          return !category.parentId && matchesSearch && matchesStatus && matchesFeatured;
        });

        // 정렬 (sortOrder 기준)
        rootCategories.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

        if (rootCategories.length === 0 && searchTerm !== '') {
          treeContainer.innerHTML = `
                            <div class="text-center py-3">
                                <p class="mb-0">"${searchTerm}" 검색 결과가 없습니다.</p>
                            </div>
                        `;
          return;
        }

        // 루트 카테고리 렌더링
        rootCategories.forEach(category => {
          const categoryElement = createCategoryTreeItem(category);
          treeContainer.appendChild(categoryElement);

          // 하위 카테고리 렌더링
          const childrenContainer = document.createElement('div');
          childrenContainer.classList.add('ms-4');
          childrenContainer.id = `children-${category.id}`;

          const childCategories = getChildCategories(category.id, showInactive, showFeaturedOnly, searchTerm);
          if (childCategories.length > 0) {
            childCategories.forEach(childCategory => {
              const childElement = createCategoryTreeItem(childCategory);
              childrenContainer.appendChild(childElement);

              // 2단계 하위 카테고리 렌더링
              const grandchildrenContainer = document.createElement('div');
              grandchildrenContainer.classList.add('ms-4');
              grandchildrenContainer.id = `children-${childCategory.id}`;

              const grandchildCategories = getChildCategories(childCategory.id, showInactive, showFeaturedOnly, searchTerm);
              if (grandchildCategories.length > 0) {
                grandchildCategories.forEach(grandchildCategory => {
                  const grandchildElement = createCategoryTreeItem(grandchildCategory);
                  grandchildrenContainer.appendChild(grandchildElement);
                });
                childrenContainer.appendChild(grandchildrenContainer);
              }
            });
            treeContainer.appendChild(childrenContainer);
          }
        });
      }

      // 하위 카테고리 가져오기
      function getChildCategories(parentId, showInactive, showFeaturedOnly, searchTerm) {
        const children = allCategories.filter(category => {
          const matchesParent = category.parentId === parentId;
          const matchesSearch = searchTerm === '' ||
                  category.name.toLowerCase().includes(searchTerm) ||
                  (category.description && category.description.toLowerCase().includes(searchTerm));
          const matchesStatus = showInactive || category.active;
          const matchesFeatured = !showFeaturedOnly || category.featured;
          return matchesParent && (matchesSearch || searchTerm === '') && matchesStatus && matchesFeatured;
        });

        // 정렬 (sortOrder 기준)
        return children.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
      }

      // 카테고리 트리 아이템 생성
      function createCategoryTreeItem(category) {
        const item = document.createElement('div');
        item.classList.add('category-tree-item', 'd-flex', 'justify-content-between', 'align-items-center');
        item.dataset.id = category.id;

        if (currentCategoryId === category.id) {
          item.classList.add('active');
        }

        const statusClass = category.active ? 'bg-success' : 'bg-danger';
        const featuredBadge = category.featured ?
                `<span class="badge bg-warning ms-1" title="추천 카테고리"><i class="fas fa-star"></i></span>` : '';

        item.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span class="drag-handle me-2"><i class="fas fa-grip-vertical text-muted"></i></span>
                            <span>${category.name}</span>
                            <span class="badge ${statusClass} category-status-badge ms-1">${category.active ? '활성' : '비활성'}</span>
                            ${featuredBadge}
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-sm btn-outline-primary edit-category-btn" data-id="${category.id}" title="수정">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-category-btn" data-id="${category.id}" data-name="${category.name}" title="삭제">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

        // 카테고리 클릭 이벤트
        item.addEventListener('click', function(e) {
          if (!e.target.closest('button')) {
            selectCategory(category.id);
          }
        });

        // 수정 버튼 이벤트
        item.querySelector('.edit-category-btn').addEventListener('click', function() {
          selectCategory(category.id);
        });

        // 삭제 버튼 이벤트
        item.querySelector('.delete-category-btn').addEventListener('click', function() {
          showDeleteCategoryModal(category.id, category.name);
        });

        return item;
      }

      // 추천 카테고리 렌더링
      function renderFeaturedCategories(categories) {
        const container = document.getElementById('featuredCategoriesContainer');
        container.innerHTML = '';

        if (categories.length === 0) {
          document.getElementById('noFeaturedCategoriesMessage').classList.remove('d-none');
          return;
        }

        categories.forEach(category => {
          const col = document.createElement('div');
          col.classList.add('col-md-3', 'col-sm-6', 'mb-4');

          const imageUrl = category.imageUrl || '/placeholder.svg?height=150&width=150';

          col.innerHTML = `
                            <div class="card h-100">
                                <img src="${imageUrl}" class="card-img-top" alt="${category.name}" style="height: 150px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">${category.name}</h5>
                                    <p class="card-text small">${category.description || '설명 없음'}</p>
                                </div>
                                <div class="card-footer d-flex justify-content-between align-items-center">
                                    <small class="text-muted">정렬 순서: ${category.sortOrder || 0}</small>
                                    <button class="btn btn-sm btn-outline-primary edit-featured-btn" data-id="${category.id}">
                                        <i class="fas fa-edit"></i> 수정
                                    </button>
                                </div>
                            </div>
                        `;

          container.appendChild(col);

          // 수정 버튼 이벤트
          col.querySelector('.edit-featured-btn').addEventListener('click', function() {
            selectCategory(category.id);
          });
        });
      }

      // 카테고리 선택
      function selectCategory(categoryId) {
        currentCategoryId = categoryId;

        // 활성 상태 업데이트
        document.querySelectorAll('.category-tree-item').forEach(item => {
          item.classList.remove('active');
          if (item.dataset.id == categoryId) {
            item.classList.add('active');
          }
        });

        // 카테고리 상세 정보 로드
        document.getElementById('noCategorySelected').classList.add('d-none');
        document.getElementById('categoryDetailForm').classList.add('d-none');
        document.getElementById('categoryDetailLoading').classList.remove('d-none');
        document.getElementById('categoryDetailActions').classList.remove('d-none');

        fetch(`/api/categories/${categoryId}`)
                .then(response => {
                  if (!response.ok) {
                    throw new Error('카테고리 정보를 불러오는데 실패했습니다.');
                  }
                  return response.json();
                })
                .then(category => {
                  populateCategoryForm(category);
                })
                .catch(error => {
                  console.error('Error:', error);
                  showToast('오류', '카테고리 정보를 불러오는데 실패했습니다.', 'error');
                })
                .finally(() => {
                  document.getElementById('categoryDetailLoading').classList.add('d-none');
                  document.getElementById('categoryDetailForm').classList.remove('d-none');
                });
      }

      // 카테고리 폼 채우기
      function populateCategoryForm(category) {
        document.getElementById('categoryId').value = category.id;
        document.getElementById('categoryName').value = category.name;
        document.getElementById('categorySlug').value = category.slug;
        document.getElementById('categoryDescription').value = category.description || '';
        document.getElementById('categoryActive').checked = category.active;
        document.getElementById('categoryFeatured').checked = category.featured;
        document.getElementById('categorySortOrder').value = category.sortOrder || 0;
        document.getElementById('categoryImageUrl').value = category.imageUrl || '';

        // 이미지 미리보기
        const imagePreview = document.getElementById('categoryImagePreview');
        if (category.imageUrl) {
          imagePreview.src = category.imageUrl;
          imagePreview.classList.remove('d-none');
        } else {
          imagePreview.classList.add('d-none');
        }

        // 상위 카테고리 선택
        const parentSelect = document.getElementById('categoryParent');
        parentSelect.value = category.parentId || '';

        // 필터링 가능한 속성 선택
        const attributesSelect = document.getElementById('filterableAttributes');
        for (let i = 0; i < attributesSelect.options.length; i++) {
          attributesSelect.options[i].selected = category.filterableAttributes &&
                  category.filterableAttributes.includes(attributesSelect.options[i].value);
        }

        // 생성일, 수정일 표시
        document.getElementById('categoryCreatedAt').textContent = formatDate(category.createdAt);
        document.getElementById('categoryUpdatedAt').textContent = formatDate(category.updatedAt);
      }

      // 상위 카테고리 옵션 채우기
      function populateParentCategoryOptions() {
        parentCategoryOptions = allCategories.map(category => ({
          id: category.id,
          name: category.name,
          parentId: category.parentId
        }));

        const parentSelects = [
          document.getElementById('categoryParent'),
          document.getElementById('newCategoryParent')
        ];

        parentSelects.forEach(select => {
          // 기존 옵션 제거 (첫 번째 옵션 제외)
          while (select.options.length > 1) {
            select.remove(1);
          }

          // 루트 카테고리 추가
          const rootCategories = parentCategoryOptions.filter(cat => !cat.parentId);
          rootCategories.sort((a, b) => a.name.localeCompare(b.name));

          rootCategories.forEach(category => {
            if (currentCategoryId && category.id == currentCategoryId) return; // 자기 자신은 제외

            const option = new Option(category.name, category.id);
            select.add(option);

            // 1단계 하위 카테고리 추가
            const childCategories = parentCategoryOptions.filter(cat => cat.parentId === category.id);
            childCategories.sort((a, b) => a.name.localeCompare(b.name));

            childCategories.forEach(childCategory => {
              if (currentCategoryId && childCategory.id == currentCategoryId) return; // 자기 자신은 제외

              const childOption = new Option(`— ${childCategory.name}`, childCategory.id);
              select.add(childOption);
            });
          });
        });
      }

      // 카테고리 저장
      document.getElementById('saveCategoryBtn').addEventListener('click', function() {
        const categoryId = document.getElementById('categoryId').value;
        const categoryData = {
          id: categoryId,
          name: document.getElementById('categoryName').value,
          slug: document.getElementById('categorySlug').value,
          description: document.getElementById('categoryDescription').value,
          parentId: document.getElementById('categoryParent').value || null,
          imageUrl: document.getElementById('categoryImageUrl').value || null,
          active: document.getElementById('categoryActive').checked,
          featured: document.getElementById('categoryFeatured').checked,
          sortOrder: parseInt(document.getElementById('categorySortOrder').value) || 0,
          filterableAttributes: Array.from(document.getElementById('filterableAttributes').selectedOptions).map(option => option.value)
        };

        fetch(`/api/categories/${categoryId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(categoryData)
        })
                .then(response => {
                  if (!response.ok) {
                    throw new Error('카테고리 저장에 실패했습니다.');
                  }
                  return response.json();
                })
                .then(data => {
                  showToast('성공', '카테고리가 성공적으로 저장되었습니다.', 'success');

                  // 카테고리 목록 새로고침
                  loadAllCategories();
                  loadFeaturedCategories();
                })
                .catch(error => {
                  console.error('Error:', error);
                  showToast('오류', '카테고리 저장에 실패했습니다.', 'error');
                });
      });

      // 새 카테고리 추가
      document.getElementById('addCategoryBtn').addEventListener('click', function() {
        const categoryData = {
          name: document.getElementById('newCategoryName').value,
          slug: document.getElementById('newCategorySlug').value,
          description: document.getElementById('newCategoryDescription').value,
          parentId: document.getElementById('newCategoryParent').value || null,
          active: document.getElementById('newCategoryActive').checked
        };

        fetch('/api/categories', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(categoryData)
        })
                .then(response => {
                  if (!response.ok) {
                    throw new Error('카테고리 추가에 실패했습니다.');
                  }
                  return response.json();
                })
                .then(data => {
                  showToast('성공', '카테고리가 성공적으로 추가되었습니다.', 'success');

                  // 모달 닫기
                  const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
                  modal.hide();

                  // 폼 초기화
                  document.getElementById('addCategoryForm').reset();

                  // 카테고리 목록 새로고침
                  loadAllCategories();

                  // 새로 추가된 카테고리 선택
                  selectCategory(data.id);
                })
                .catch(error => {
                  console.error('Error:', error);
                  showToast('오류', '카테고리 추가에 실패했습니다.', 'error');
                });
      });

      // 카테고리 삭제 모달 표시
      function showDeleteCategoryModal(categoryId, categoryName) {
        document.getElementById('deleteCategoryName').textContent = categoryName;

        // 하위 카테고리 확인
        const hasChildren = allCategories.some(category => category.parentId === categoryId);
        if (hasChildren) {
          document.getElementById('deleteCategoryWarning').textContent =
                  '이 카테고리에는 하위 카테고리가 있습니다. 삭제하면 하위 카테고리도 함께 삭제됩니다.';
        } else {
          document.getElementById('deleteCategoryWarning').textContent =
                  '이 카테고리에 속한 모든 상품은 카테고리가 없는 상태가 됩니다.';
        }

        // 삭제 확인 버튼 이벤트
        const confirmBtn = document.getElementById('confirmDeleteCategoryBtn');
        confirmBtn.onclick = function() {
          deleteCategory(categoryId);
        };

        // 모달 표시
        const modal = new bootstrap.Modal(document.getElementById('deleteCategoryModal'));
        modal.show();
      }

      // 카테고리 삭제
      function deleteCategory(categoryId) {
        fetch(`/api/categories/${categoryId}`, {
          method: 'DELETE'
        })
                .then(response => {
                  if (!response.ok) {
                    throw new Error('카테고리 삭제에 실패했습니다.');
                  }
                  return response.json();
                })
                .then(data => {
                  showToast('성공', '카테고리가 성공적으로 삭제되었습니다.', 'success');

                  // 모달 닫기
                  const modal = bootstrap.Modal.getInstance(document.getElementById('deleteCategoryModal'));
                  modal.hide();

                  // 카테고리 목록 새로고침
                  loadAllCategories();
                  loadFeaturedCategories();

                  // 상세 정보 영역 초기화
                  if (currentCategoryId === categoryId) {
                    currentCategoryId = null;
                    document.getElementById('categoryDetailForm').classList.add('d-none');
                    document.getElementById('categoryDetailActions').classList.add('d-none');
                    document.getElementById('noCategorySelected').classList.remove('d-none');
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  showToast('오류', '카테고리 삭제에 실패했습니다.', 'error');
                });
      }

      // 이미지 업로드 버튼 클릭
      document.getElementById('uploadImageBtn').addEventListener('click', function() {
        // 이미지 미리보기 초기화
        document.getElementById('uploadImagePreview').src = '/placeholder.svg?height=200&width=200';
        document.getElementById('categoryImageFile').value = '';

        // 모달 표시
        const modal = new bootstrap.Modal(document.getElementById('uploadImageModal'));
        modal.show();
      });

      // 이미지 파일 선택 시 미리보기
      document.getElementById('categoryImageFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('uploadImagePreview').src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // 이미지 업로드 확인
      document.getElementById('confirmUploadImageBtn').addEventListener('click', function() {
        const fileInput = document.getElementById('categoryImageFile');
        if (fileInput.files.length === 0) {
          showToast('경고', '업로드할 이미지 파일을 선택해주세요.', 'warning');
          return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        // 이미지 업로드 API 호출 (실제 구현 필요)
        fetch('/api/upload/image', {
          method: 'POST',
          body: formData
        })
                .then(response => {
                  if (!response.ok) {
                    throw new Error('이미지 업로드에 실패했습니다.');
                  }
                  return response.json();
                })
                .then(data => {
                  // 업로드된 이미지 URL 설정
                  document.getElementById('categoryImageUrl').value = data.url;
                  document.getElementById('categoryImagePreview').src = data.url;
                  document.getElementById('categoryImagePreview').classList.remove('d-none');

                  // 모달 닫기
                  const modal = bootstrap.Modal.getInstance(document.getElementById('uploadImageModal'));
                  modal.hide();

                  showToast('성공', '이미지가 성공적으로 업로드되었습니다.', 'success');
                })
                .catch(error => {
                  console.error('Error:', error);
                  showToast('오류', '이미지 업로드에 실패했습니다.', 'error');
                });
      });

      // 카테고리 검색 이벤트
      document.getElementById('searchCategoryBtn').addEventListener('click', function() {
        renderCategoryTree();
      });

      document.getElementById('categorySearch').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          renderCategoryTree();
        }
      });

      // 필터 변경 이벤트
      document.getElementById('showInactiveCategories').addEventListener('change', renderCategoryTree);
      document.getElementById('showFeaturedOnly').addEventListener('change', renderCategoryTree);

      // 슬러그 자동 생성 (카테고리명 입력 시)
      document.getElementById('newCategoryName').addEventListener('input', function() {
        const name = this.value;
        const slug = name.toLowerCase()
                .replace(/[^a-z0-9가-힣]/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
        document.getElementById('newCategorySlug').value = slug;
      });

      document.getElementById('categoryName').addEventListener('input', function() {
        const name = this.value;
        const slug = name.toLowerCase()
                .replace(/[^a-z0-9가-힣]/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
        document.getElementById('categorySlug').value = slug;
      });

      // 유틸리티 함수: 날짜 포맷팅
      function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // 유틸리티 함수: 토스트 메시지 표시
      function showToast(title, message, type) {
        // 토스트 구현 (Bootstrap 토스트 또는 다른 라이브러리 사용)
        console.log(`[${type}] ${title}: ${message}`);
      }
    });
  </script>
</div>
</body>
</html>

