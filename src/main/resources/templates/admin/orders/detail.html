<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin}">
<head>
    <title>주문 상세 - PeakMeShop</title>
</head>
<body>
<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">주문 상세</h1>
        <div>
            <a th:href="@{/admin/orders}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> 주문 목록
            </a>
            <button class="btn btn-danger" onclick="cancelOrder()" th:if="${order.status.name() == 'PAYMENT_COMPLETED' || order.status.name() == 'PREPARING'}">주문 취소</button>
        </div>
    </div>

    <!-- 주문 정보 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">주문 정보</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">주문 번호</dt>
                        <dd class="col-sm-8" th:text="${order.orderNumber}">ORDER-20230101-123456</dd>

                        <dt class="col-sm-4">주문 상태</dt>
                        <dd class="col-sm-8">
                            <span class="badge" th:classappend="${'bg-' + order.status.color}"
                                  th:text="${order.status.displayName}">결제완료</span>
                        </dd>

                        <dt class="col-sm-4">주문 일시</dt>
                        <dd class="col-sm-8" th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm')}">2023-01-01 12:34</dd>

                        <dt class="col-sm-4">총 결제 금액</dt>
                        <dd class="col-sm-8" th:text="${#numbers.formatCurrency(order.totalAmount)}">65,000원</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">주문자</dt>
                        <dd class="col-sm-8" th:text="${order.ordererName}">홍길동</dd>

                        <dt class="col-sm-4">연락처</dt>
                        <dd class="col-sm-8" th:text="${order.ordererPhone}">010-1234-5678</dd>

                        <dt class="col-sm-4">이메일</dt>
                        <dd class="col-sm-8" th:text="${order.ordererEmail}">hong@example.com</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- 배송 정보 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">배송 정보</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">받는 사람</dt>
                        <dd class="col-sm-8" th:text="${order.receiverName}">홍길동</dd>

                        <dt class="col-sm-4">연락처</dt>
                        <dd class="col-sm-8" th:text="${order.receiverPhone}">010-1234-5678</dd>

                        <dt class="col-sm-4">주소</dt>
                        <dd class="col-sm-8">
                            <div th:text="${'(' + order.zipCode + ') ' + order.address1}">
                                (12345) 서울시 강남구 테헤란로 123
                            </div>
                            <div th:text="${order.address2}">
                                456호
                            </div>
                        </dd>

                        <dt class="col-sm-4">배송 요청사항</dt>
                        <dd class="col-sm-8" th:text="${order.deliveryRequest}">문 앞에 놓아주세요</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">택배사</dt>
                        <dd class="col-sm-8" th:text="${order.courierName}">CJ대한통운</dd>

                        <dt class="col-sm-4">운송장 번호</dt>
                        <dd class="col-sm-8">
                            <span th:text="${order.trackingNumber}">1234567890</span>
                            <a th:href="${order.trackingUrl}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">배송 조회</a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- 주문 상품 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">주문 상품</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                    <tr>
                        <th>상품명</th>
                        <th>옵션</th>
                        <th>수량</th>
                        <th>가격</th>
                        <th>상태</th>
                        <th>관리</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="item : ${order.orderItems}">
                        <td th:text="${item.productName}">상품명</td>
                        <td>
                                <span th:each="option : ${item.options.entrySet()}"
                                      th:text="${option.key + ': ' + option.value}"
                                      class="badge bg-secondary me-1">옵션</span>
                        </td>
                        <td th:text="${item.quantity}">2</td>
                        <td th:text="${#numbers.formatCurrency(item.price * item.quantity)}">20,000원</td>
                        <td>
                                <span class="badge" th:classappend="${'bg-' + item.status.color}"
                                      th:text="${item.status.displayName}">결제완료</span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    상태 변경
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" th:onclick="'updateOrderItemStatus(' + ${item.id} + ', &quot;PREPARING&quot;)'">상품준비중</a></li>
                                    <li><a class="dropdown-item" href="#" th:onclick="'updateOrderItemStatus(' + ${item.id} + ', &quot;SHIPPING&quot;)'">배송중</a></li>
                                    <li><a class="dropdown-item" href="#" th:onclick="'updateOrderItemStatus(' + ${item.id} + ', &quot;DELIVERED&quot;)'">배송완료</a></li>
                                    <li><a class="dropdown-item" href="#" th:onclick="'updateOrderItemStatus(' + ${item.id} + ', &quot;CANCELED&quot;)'">취소</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 결제 정보 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">결제 정보</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">결제 방법</dt>
                        <dd class="col-sm-8" th:text="${order.paymentMethod.displayName}">신용카드</dd>

                        <dt class="col-sm-4">결제 일시</dt>
                        <dd class="col-sm-8" th:text="${#temporals.format(order.paidAt, 'yyyy-MM-dd HH:mm')}">2023-01-01 12:34</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4">상품 금액</dt>
                        <dd class="col-sm-8" th:text="${#numbers.formatCurrency(order.productAmount)}">50,000원</dd>

                        <dt class="col-sm-4">할인 금액</dt>
                        <dd class="col-sm-8" th:text="${#numbers.formatCurrency(order.discountAmount)}">-5,000원</dd>

                        <dt class="col-sm-4">배송비</dt>
                        <dd class="col-sm-8" th:text="${#numbers.formatCurrency(order.shippingFee)}">3,000원</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        // 주문 취소
        function cancelOrder() {
            if (confirm('주문을 취소하시겠습니까?')) {
                // CSRF 토큰 가져오기
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                fetch('/api/admin/orders/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({
                        orderId: [[${order.id}]]
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('주문이 취소되었습니다.', 'success');
                            // 페이지 새로고침
                            window.location.reload();
                        } else {
                            showToast(data.message || '주문 취소에 실패했습니다.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('주문 취소 오류:', error);
                        showToast('주문 취소 중 오류가 발생했습니다.', 'error');
                    });
            }
        }

        // 주문 상품 상태 업데이트
        function updateOrderItemStatus(orderItemId, status) {
            // CSRF 토큰 가져오기
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch('/api/admin/orders/item/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    orderItemId: orderItemId,
                    status: status
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('주문 상품 상태가 변경되었습니다.', 'success');
                        // 페이지 새로고침
                        window.location.reload();
                    } else {
                        showToast(data.message || '주문 상품 상태 변경에 실패했습니다.', 'error');
                    }
                })
                .catch(error => {
                    console.error('주문 상품 상태 변경 오류:', error);
                    showToast('주문 상품 상태 변경 중 오류가 발생했습니다.', 'error');
                });
        }
    </script>
</th:block>
</body>
</html>