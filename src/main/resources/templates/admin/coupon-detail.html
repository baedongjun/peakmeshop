<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">
<head>
    <title>쿠폰 상세 - PeakMeShop 관리자</title>
    <meta name="description" content="쿠폰 상세 정보 페이지입니다.">
    <style>
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status-expired {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .status-scheduled {
            background-color: #fff3cd;
            color: #856404;
        }
        .usage-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .usage-used {
            background-color: #d4edda;
            color: #155724;
        }
        .usage-unused {
            background-color: #cce5ff;
            color: #004085;
        }
        .usage-expired {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .usage-canceled {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid px-4">
        <h1 class="mt-4">쿠폰 상세</h1>
        <ol class="breadcrumb mb-4">
            <li class="breadcrumb-item"><a href="/admin">대시보드</a></li>
            <li class="breadcrumb-item"><a href="/admin/coupons">쿠폰 관리</a></li>
            <li class="breadcrumb-item active">쿠폰 상세</li>
        </ol>

        <!-- 쿠폰 기본 정보 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-info-circle me-1"></i>
                    쿠폰 기본 정보
                </div>
                <div>
                    <button type="button" class="btn btn-primary me-2" id="editCouponBtn">
                        <i class="fas fa-edit"></i> 수정
                    </button>
                    <button type="button" class="btn btn-success me-2" id="issueCouponBtn">
                        <i class="fas fa-paper-plane"></i> 발급
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteCouponBtn">
                        <i class="fas fa-trash"></i> 삭제
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-bordered">
                            <tr>
                                <th class="table-light" style="width: 30%">쿠폰 ID</th>
                                <td id="couponId"></td>
                            </tr>
                            <tr>
                                <th class="table-light">쿠폰 코드</th>
                                <td id="couponCode"></td>
                            </tr>
                            <tr>
                                <th class="table-light">쿠폰명</th>
                                <td id="couponName"></td>
                            </tr>
                            <tr>
                                <th class="table-light">할인 유형</th>
                                <td id="discountType"></td>
                            </tr>
                            <tr>
                                <th class="table-light">할인 값</th>
                                <td id="discountValue"></td>
                            </tr>
                            <tr>
                                <th class="table-light">최소 주문금액</th>
                                <td id="minOrderAmount"></td>
                            </tr>
                            <tr>
                                <th class="table-light">최대 할인금액</th>
                                <td id="maxDiscountAmount"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-bordered">
                            <tr>
                                <th class="table-light" style="width: 30%">시작일</th>
                                <td id="startDate"></td>
                            </tr>
                            <tr>
                                <th class="table-light">종료일</th>
                                <td id="endDate"></td>
                            </tr>
                            <tr>
                                <th class="table-light">사용 제한</th>
                                <td id="usageLimit"></td>
                            </tr>
                            <tr>
                                <th class="table-light">사용 횟수</th>
                                <td id="usedCount"></td>
                            </tr>
                            <tr>
                                <th class="table-light">상태</th>
                                <td><span id="status" class="status-badge"></span></td>
                            </tr>
                            <tr>
                                <th class="table-light">등록일</th>
                                <td id="createdAt"></td>
                            </tr>
                            <tr>
                                <th class="table-light">수정일</th>
                                <td id="updatedAt"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-align-left me-1"></i>
                                쿠폰 설명
                            </div>
                            <div class="card-body">
                                <p id="couponDescription" class="mb-0"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 쿠폰 발급 현황 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-users me-1"></i>
                    쿠폰 발급 현황
                </div>
                <div>
                    <button type="button" class="btn btn-success me-2" id="exportIssuedCouponsBtn">
                        <i class="fas fa-file-excel"></i> 엑셀 내보내기
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- 검색 및 필터 -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="memberSearchKeyword" class="form-label">회원 검색</label>
                        <input type="text" class="form-control" id="memberSearchKeyword" placeholder="회원 ID, 이름, 이메일">
                    </div>
                    <div class="col-md-2">
                        <label for="usageStatusFilter" class="form-label">사용 상태</label>
                        <select class="form-select" id="usageStatusFilter">
                            <option value="">전체</option>
                            <option value="UNUSED">미사용</option>
                            <option value="USED">사용됨</option>
                            <option value="EXPIRED">만료됨</option>
                            <option value="CANCELED">취소됨</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="issuedDateSort" class="form-label">정렬</label>
                        <select class="form-select" id="issuedDateSort">
                            <option value="issuedAt,desc">발급일 최신순</option>
                            <option value="issuedAt,asc">발급일 오래된순</option>
                            <option value="usedAt,desc">사용일 최신순</option>
                            <option value="usedAt,asc">사용일 오래된순</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label for="issuedSize" class="form-label">표시개수</label>
                        <select class="form-select" id="issuedSize">
                            <option value="10">10개</option>
                            <option value="20">20개</option>
                            <option value="50">50개</option>
                            <option value="100">100개</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-primary me-2" id="searchIssuedBtn">
                            <i class="fas fa-search"></i> 검색
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetIssuedBtn">
                            <i class="fas fa-undo"></i> 초기화
                        </button>
                    </div>
                </div>

                <!-- 발급 현황 테이블 -->
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="issuedCouponsTable" width="100%" cellspacing="0">
                        <thead>
                        <tr>
                            <th>발급 ID</th>
                            <th>회원 ID</th>
                            <th>회원명</th>
                            <th>이메일</th>
                            <th>발급일</th>
                            <th>사용일</th>
                            <th>주문 ID</th>
                            <th>상태</th>
                            <th>관리</th>
                        </tr>
                        </thead>
                        <tbody id="issuedCouponsList">
                        <!-- 발급된 쿠폰 목록이 여기에 동적으로 로드됩니다 -->
                        </tbody>
                    </table>
                </div>

                <!-- 페이지네이션 -->
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center" id="issuedPagination">
                        <!-- 페이지네이션이 여기에 동적으로 로드됩니다 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 쿠폰 수정 모달 -->
    <div class="modal fade" id="editCouponModal" tabindex="-1" aria-labelledby="editCouponModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCouponModalLabel">쿠폰 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCouponForm">
                        <input type="hidden" id="editCouponId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editCouponCode" class="form-label">쿠폰 코드 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editCouponCode" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editCouponName" class="form-label">쿠폰명 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editCouponName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editCouponDescription" class="form-label">쿠폰 설명</label>
                            <textarea class="form-control" id="editCouponDescription" rows="2"></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editDiscountType" class="form-label">할인 유형 <span class="text-danger">*</span></label>
                                <select class="form-select" id="editDiscountType" required>
                                    <option value="PERCENTAGE">퍼센트 할인 (%)</option>
                                    <option value="FIXED_AMOUNT">정액 할인 (원)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editDiscountValue" class="form-label">할인 값 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editDiscountValue" min="0" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editMinOrderAmount" class="form-label">최소 주문금액</label>
                                <input type="number" class="form-control" id="editMinOrderAmount" min="0">
                            </div>
                            <div class="col-md-6">
                                <label for="editMaxDiscountAmount" class="form-label">최대 할인금액</label>
                                <input type="number" class="form-control" id="editMaxDiscountAmount" min="0">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editStartDate" class="form-label">시작일 <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="editStartDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editEndDate" class="form-label">종료일 <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="editEndDate" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="editUsageLimit" class="form-label">사용 제한 (0 = 무제한)</label>
                                <input type="number" class="form-control" id="editUsageLimit" min="0" value="0">
                            </div>
                            <div class="col-md-6">
                                <label for="editCouponStatus" class="form-label">상태 <span class="text-danger">*</span></label>
                                <select class="form-select" id="editCouponStatus" required>
                                    <option value="ACTIVE">활성</option>
                                    <option value="INACTIVE">비활성</option>
                                    <option value="SCHEDULED">예약됨</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="saveEditCouponBtn">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 쿠폰 발급 모달 -->
    <div class="modal fade" id="issueCouponModal" tabindex="-1" aria-labelledby="issueCouponModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="issueCouponModalLabel">쿠폰 발급</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="issueCouponId">
                    <div class="mb-3">
                        <label class="form-label">쿠폰명</label>
                        <p id="issueCouponName" class="form-control-plaintext"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">발급 방식</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="issueType" id="issueTypeAll" value="all" checked>
                            <label class="form-check-label" for="issueTypeAll">
                                전체 회원에게 발급
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="issueType" id="issueTypeSelect" value="select">
                            <label class="form-check-label" for="issueTypeSelect">
                                특정 회원에게 발급
                            </label>
                        </div>
                    </div>
                    <div class="mb-3" id="memberSelectDiv" style="display: none;">
                        <label for="memberId" class="form-label">회원 선택</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="memberSearchKeyword" placeholder="회원 ID, 이름, 이메일 검색">
                            <button class="btn btn-outline-secondary" type="button" id="searchMemberBtn">검색</button>
                        </div>
                        <div class="mt-2" id="memberSearchResults" style="max-height: 200px; overflow-y: auto;">
                            <!-- 회원 검색 결과가 여기에 표시됩니다 -->
                        </div>
                        <input type="hidden" id="selectedMemberId">
                        <div class="mt-2" id="selectedMemberInfo" style="display: none;">
                            <div class="alert alert-info">
                                선택된 회원: <span id="selectedMemberName"></span> (<span id="selectedMemberEmail"></span>)
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="issueCouponConfirmBtn">발급</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div class="modal fade" id="deleteCouponModal" tabindex="-1" aria-labelledby="deleteCouponModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteCouponModalLabel">쿠폰 삭제</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>정말로 이 쿠폰을 삭제하시겠습니까?</p>
                    <p>쿠폰명: <span id="deleteCouponName"></span></p>
                    <p class="text-danger">이 작업은 되돌릴 수 없으며, 이미 발급된 쿠폰에도 영향을 미칠 수 있습니다.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">삭제</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 쿠폰 사용 취소 모달 -->
    <div class="modal fade" id="cancelCouponModal" tabindex="-1" aria-labelledby="cancelCouponModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelCouponModalLabel">쿠폰 사용 취소</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>이 쿠폰의 사용을 취소하시겠습니까?</p>
                    <p>회원: <span id="cancelMemberName"></span></p>
                    <p>주문 ID: <span id="cancelOrderId"></span></p>
                    <input type="hidden" id="cancelMemberCouponId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="confirmCancelBtn">확인</button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const couponId = window.location.pathname.split('/').pop();
            let issuedCurrentPage = 0;
            let issuedTotalPages = 0;

            // 쿠폰 상세 정보 로드
            loadCouponDetails();

            // 발급된 쿠폰 목록 로드
            loadIssuedCoupons();

            // 수정 버튼 클릭 이벤트
            document.getElementById('editCouponBtn').addEventListener('click', function() {
                openEditModal();
            });

            // 발급 버튼 클릭 이벤트
            document.getElementById('issueCouponBtn').addEventListener('click', function() {
                openIssueModal();
            });

            // 삭제 버튼 클릭 이벤트
            document.getElementById('deleteCouponBtn').addEventListener('click', function() {
                openDeleteModal();
            });

            // 쿠폰 수정 저장 버튼 클릭 이벤트
            document.getElementById('saveEditCouponBtn').addEventListener('click', function() {
                updateCoupon();
            });

            // 쿠폰 발급 확인 버튼 클릭 이벤트
            document.getElementById('issueCouponConfirmBtn').addEventListener('click', function() {
                issueCoupon();
            });

            // 쿠폰 삭제 확인 버튼 클릭 이벤트
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                deleteCoupon();
            });

            // 쿠폰 사용 취소 확인 버튼 클릭 이벤트
            document.getElementById('confirmCancelBtn').addEventListener('click', function() {
                cancelUsedCoupon();
            });

            // 발급 쿠폰 검색 버튼 클릭 이벤트
            document.getElementById('searchIssuedBtn').addEventListener('click', function() {
                issuedCurrentPage = 0;
                loadIssuedCoupons();
            });

            // 발급 쿠폰 초기화 버튼 클릭 이벤트
            document.getElementById('resetIssuedBtn').addEventListener('click', function() {
                document.getElementById('memberSearchKeyword').value = '';
                document.getElementById('usageStatusFilter').value = '';
                document.getElementById('issuedDateSort').value = 'issuedAt,desc';
                document.getElementById('issuedSize').value = '10';
                issuedCurrentPage = 0;
                loadIssuedCoupons();
            });

            // 발급 쿠폰 엑셀 내보내기 버튼 클릭 이벤트
            document.getElementById('exportIssuedCouponsBtn').addEventListener('click', function() {
                exportIssuedCoupons();
            });

            // 회원 검색 버튼 클릭 이벤트
            document.getElementById('searchMemberBtn').addEventListener('click', function() {
                searchMembers();
            });

            // 발급 방식 라디오 버튼 변경 이벤트
            document.querySelectorAll('input[name="issueType"]').forEach(function(radio) {
                radio.addEventListener('change', function() {
                    if (this.value === 'select') {
                        document.getElementById('memberSelectDiv').style.display = 'block';
                    } else {
                        document.getElementById('memberSelectDiv').style.display = 'none';
                    }
                });
            });

            // 쿠폰 상세 정보 로드 함수
            function loadCouponDetails() {
                fetch(`/api/coupons/${couponId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('쿠폰 정보를 불러오는데 실패했습니다.');
                        }
                        return response.json();
                    })
                    .then(coupon => {
                        renderCouponDetails(coupon);
                    })
                    .catch(error => {
                        console.error('Error loading coupon details:', error);
                        alert(error.message);
                    });
            }

            // 쿠폰 상세 정보 렌더링 함수
            function renderCouponDetails(coupon) {
                document.getElementById('couponId').textContent = coupon.id;
                document.getElementById('couponCode').textContent = coupon.code;
                document.getElementById('couponName').textContent = coupon.name;

                // 할인 유형 및 값 표시 형식 설정
                let discountTypeText = '';
                let discountValueText = '';
                if (coupon.discountType === 'PERCENTAGE') {
                    discountTypeText = '퍼센트 할인';
                    discountValueText = `${coupon.discountValue}%`;
                } else {
                    discountTypeText = '정액 할인';
                    discountValueText = `${coupon.discountValue.toLocaleString()}원`;
                }
                document.getElementById('discountType').textContent = discountTypeText;
                document.getElementById('discountValue').textContent = discountValueText;

                document.getElementById('minOrderAmount').textContent = coupon.minOrderAmount ? `${coupon.minOrderAmount.toLocaleString()}원` : '-';
                document.getElementById('maxDiscountAmount').textContent = coupon.maxDiscountAmount ? `${coupon.maxDiscountAmount.toLocaleString()}원` : '-';
                document.getElementById('startDate').textContent = formatDateTime(coupon.startDate);
                document.getElementById('endDate').textContent = formatDateTime(coupon.endDate);
                document.getElementById('usageLimit').textContent = coupon.usageLimit > 0 ? coupon.usageLimit : '무제한';
                document.getElementById('usedCount').textContent = coupon.usedCount;

                // 상태에 따른 배지 클래스 설정
                const statusElement = document.getElementById('status');
                let statusClass = '';
                let statusText = '';

                switch (coupon.status) {
                    case 'ACTIVE':
                        statusClass = 'status-active';
                        statusText = '활성';
                        break;
                    case 'INACTIVE':
                        statusClass = 'status-inactive';
                        statusText = '비활성';
                        break;
                    case 'EXPIRED':
                        statusClass = 'status-expired';
                        statusText = '만료됨';
                        break;
                    case 'SCHEDULED':
                        statusClass = 'status-scheduled';
                        statusText = '예약됨';
                        break;
                    default:
                        statusClass = '';
                        statusText = coupon.status;
                }

                statusElement.className = `status-badge ${statusClass}`;
                statusElement.textContent = statusText;

                document.getElementById('createdAt').textContent = formatDateTime(coupon.createdAt);
                document.getElementById('updatedAt').textContent = formatDateTime(coupon.updatedAt);
                document.getElementById('couponDescription').textContent = coupon.description || '설명이 없습니다.';

                // 페이지 타이틀 업데이트
                document.title = `${coupon.name} - 쿠폰 상세 - PeakMeShop 관리자`;
            }

            // 발급된 쿠폰 목록 로드 함수
            function loadIssuedCoupons() {
                const memberKeyword = document.getElementById('memberSearchKeyword').value;
                const usageStatus = document.getElementById('usageStatusFilter').value;
                const sort = document.getElementById('issuedDateSort').value;
                const size = document.getElementById('issuedSize').value;

                let url = `/api/coupons/${couponId}/issued?page=${issuedCurrentPage}&size=${size}&sort=${sort}`;

                if (memberKeyword) {
                    url += `&memberKeyword=${encodeURIComponent(memberKeyword)}`;
                }

                if (usageStatus) {
                    url += `&status=${usageStatus}`;
                }

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('발급된 쿠폰 목록을 불러오는데 실패했습니다.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        renderIssuedCoupons(data);
                    })
                    .catch(error => {
                        console.error('Error loading issued coupons:', error);
                        alert(error.message);
                    });
            }

            // 발급된 쿠폰 목록 렌더링 함수
            function renderIssuedCoupons(data) {
                const issuedCouponsList = document.getElementById('issuedCouponsList');
                issuedCouponsList.innerHTML = '';

                if (data.content && data.content.length > 0) {
                    data.content.forEach(memberCoupon => {
                        const row = document.createElement('tr');

                        // 상태에 따른 배지 클래스 설정
                        let usageClass = '';
                        let usageText = '';

                        switch (memberCoupon.status) {
                            case 'UNUSED':
                                usageClass = 'usage-unused';
                                usageText = '미사용';
                                break;
                            case 'USED':
                                usageClass = 'usage-used';
                                usageText = '사용됨';
                                break;
                            case 'EXPIRED':
                                usageClass = 'usage-expired';
                                usageText = '만료됨';
                                break;
                            case 'CANCELED':
                                usageClass = 'usage-canceled';
                                usageText = '취소됨';
                                break;
                            default:
                                usageClass = '';
                                usageText = memberCoupon.status;
                        }

                        row.innerHTML = `
                                <td>${memberCoupon.id}</td>
                                <td>${memberCoupon.memberId}</td>
                                <td>${memberCoupon.memberName}</td>
                                <td>${memberCoupon.memberEmail}</td>
                                <td>${formatDateTime(memberCoupon.issuedAt)}</td>
                                <td>${memberCoupon.usedAt ? formatDateTime(memberCoupon.usedAt) : '-'}</td>
                                <td>${memberCoupon.orderId ? `<a href="/admin/orders/${memberCoupon.orderId}" class="text-primary">${memberCoupon.orderId}</a>` : '-'}</td>
                                <td><span class="usage-badge ${usageClass}">${usageText}</span></td>
                                <td>
                                    ${memberCoupon.status === 'USED' ?
                            `<button type="button" class="btn btn-sm btn-warning" onclick="cancelCoupon(${memberCoupon.id}, '${memberCoupon.memberName}', ${memberCoupon.orderId})">
                                            <i class="fas fa-undo"></i> 사용취소
                                        </button>` :
                            '-'
                        }
                                </td>
                            `;

                        issuedCouponsList.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="9" class="text-center">발급된 쿠폰이 없습니다.</td>';
                    issuedCouponsList.appendChild(row);
                }

                // 페이지네이션 업데이트
                issuedTotalPages = data.totalPages;
                updateIssuedPagination(data.number, data.totalPages);
            }

            // 발급된 쿠폰 페이지네이션 업데이트 함수
            function updateIssuedPagination(currentPageNum, totalPagesNum) {
                const pagination = document.getElementById('issuedPagination');
                pagination.innerHTML = '';

                // 이전 페이지 버튼
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPageNum === 0 ? 'disabled' : ''}`;
                prevLi.innerHTML = `
                        <a class="page-link" href="#" aria-label="Previous" ${currentPageNum === 0 ? 'tabindex="-1" aria-disabled="true"' : ''}>
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    `;
                if (currentPageNum > 0) {
                    prevLi.addEventListener('click', function(e) {
                        e.preventDefault();
                        issuedCurrentPage = currentPageNum - 1;
                        loadIssuedCoupons();
                    });
                }
                pagination.appendChild(prevLi);

                // 페이지 번호 버튼
                const startPage = Math.max(0, currentPageNum - 2);
                const endPage = Math.min(totalPagesNum - 1, currentPageNum + 2);

                for (let i = startPage; i <= endPage; i++) {
                    const pageLi = document.createElement('li');
                    pageLi.className = `page-item ${i === currentPageNum ? 'active' : ''}`;
                    pageLi.innerHTML = `<a class="page-link" href="#">${i + 1}</a>`;

                    pageLi.addEventListener('click', function(e) {
                        e.preventDefault();
                        issuedCurrentPage = i;
                        loadIssuedCoupons();
                    });

                    pagination.appendChild(pageLi);
                }

                // 다음 페이지 버튼
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPageNum === totalPagesNum - 1 ? 'disabled' : ''}`;
                nextLi.innerHTML = `
                        <a class="page-link" href="#" aria-label="Next" ${currentPageNum === totalPagesNum - 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    `;
                if (currentPageNum < totalPagesNum - 1) {
                    nextLi.addEventListener('click', function(e) {
                        e.preventDefault();
                        issuedCurrentPage = currentPageNum + 1;
                        loadIssuedCoupons();
                    });
                }
                pagination.appendChild(nextLi);
            }

            // 쿠폰 수정 모달 열기 함수
            function openEditModal() {
                fetch(`/api/coupons/${couponId}`)
                    .then(response => response.json())
                    .then(coupon => {
                        document.getElementById('editCouponId').value = coupon.id;
                        document.getElementById('editCouponCode').value = coupon.code;
                        document.getElementById('editCouponName').value = coupon.name;
                        document.getElementById('editCouponDescription').value = coupon.description || '';
                        document.getElementById('editDiscountType').value = coupon.discountType;
                        document.getElementById('editDiscountValue').value = coupon.discountValue;
                        document.getElementById('editMinOrderAmount').value = coupon.minOrderAmount || '';
                        document.getElementById('editMaxDiscountAmount').value = coupon.maxDiscountAmount || '';

                        // 날짜 포맷팅
                        if (coupon.startDate) {
                            document.getElementById('editStartDate').value = formatDateForInput(coupon.startDate);
                        }
                        if (coupon.endDate) {
                            document.getElementById('editEndDate').value = formatDateForInput(coupon.endDate);
                        }

                        document.getElementById('editUsageLimit').value = coupon.usageLimit || 0;
                        document.getElementById('editCouponStatus').value = coupon.status;

                        const modal = new bootstrap.Modal(document.getElementById('editCouponModal'));
                        modal.show();
                    })
                    .catch(error => {
                        console.error('Error loading coupon details for edit:', error);
                        alert('쿠폰 정보를 불러오는 중 오류가 발생했습니다.');
                    });
            }

            // 쿠폰 발급 모달 열기 함수
            function openIssueModal() {
                fetch(`/api/coupons/${couponId}`)
                    .then(response => response.json())
                    .then(coupon => {
                        document.getElementById('issueCouponId').value = coupon.id;
                        document.getElementById('issueCouponName').textContent = coupon.name;
                        document.getElementById('issueTypeAll').checked = true;
                        document.getElementById('memberSelectDiv').style.display = 'none';
                        document.getElementById('memberSearchKeyword').value = '';
                        document.getElementById('memberSearchResults').innerHTML = '';
                        document.getElementById('selectedMemberId').value = '';
                        document.getElementById('selectedMemberInfo').style.display = 'none';

                        const modal = new bootstrap.Modal(document.getElementById('issueCouponModal'));
                        modal.show();
                    })
                    .catch(error => {
                        console.error('Error loading coupon details for issue:', error);
                        alert('쿠폰 정보를 불러오는 중 오류가 발생했습니다.');
                    });
            }

            // 쿠폰 삭제 모달 열기 함수
            function openDeleteModal() {
                fetch(`/api/coupons/${couponId}`)
                    .then(response => response.json())
                    .then(coupon => {
                        document.getElementById('deleteCouponName').textContent = coupon.name;

                        const modal = new bootstrap.Modal(document.getElementById('deleteCouponModal'));
                        modal.show();
                    })
                    .catch(error => {
                        console.error('Error loading coupon details for delete:', error);
                        alert('쿠폰 정보를 불러오는 중 오류가 발생했습니다.');
                    });
            }

            // 쿠폰 수정 함수
            function updateCoupon() {
                const couponData = {
                    id: document.getElementById('editCouponId').value,
                    code: document.getElementById('editCouponCode').value,
                    name: document.getElementById('editCouponName').value,
                    description: document.getElementById('editCouponDescription').value,
                    discountType: document.getElementById('editDiscountType').value,
                    discountValue: parseFloat(document.getElementById('editDiscountValue').value),
                    minOrderAmount: document.getElementById('editMinOrderAmount').value ? parseFloat(document.getElementById('editMinOrderAmount').value) : null,
                    maxDiscountAmount: document.getElementById('editMaxDiscountAmount').value ? parseFloat(document.getElementById('editMaxDiscountAmount').value) : null,
                    startDate: document.getElementById('editStartDate').value,
                    endDate: document.getElementById('editEndDate').value,
                    usageLimit: parseInt(document.getElementById('editUsageLimit').value),
                    status: document.getElementById('editCouponStatus').value
                };

                fetch(`/api/coupons/${couponId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(couponData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('쿠폰 수정에 실패했습니다.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editCouponModal'));
                        modal.hide();
                        alert('쿠폰이 수정되었습니다.');
                        loadCouponDetails();
                    })
                    .catch(error => {
                        console.error('Error updating coupon:', error);
                        alert(error.message);
                    });
            }

            // 쿠폰 발급 함수
            function issueCoupon() {
                const issueType = document.querySelector('input[name="issueType"]:checked').value;

                if (issueType === 'all') {
                    // 전체 회원에게 발급
                    fetch(`/api/coupons/${couponId}/issue-all`, {
                        method: 'POST'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('쿠폰 발급에 실패했습니다.');
                            }
                            return response.json();
                        })
                        .then(data => {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('issueCouponModal'));
                            modal.hide();
                            alert('쿠폰이 전체 회원에게 발급되었습니다.');
                            loadIssuedCoupons();
                        })
                        .catch(error => {
                            console.error('Error issuing coupon to all members:', error);
                            alert(error.message);
                        });
                } else {
                    // 특정 회원에게 발급
                    const memberId = document.getElementById('selectedMemberId').value;
                    if (!memberId) {
                        alert('회원을 선택해주세요.');
                        return;
                    }

                    fetch(`/api/coupons/${couponId}/issue/${memberId}`, {
                        method: 'POST'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('쿠폰 발급에 실패했습니다.');
                            }
                            return response.json();
                        })
                        .then(data => {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('issueCouponModal'));
                            modal.hide();
                            alert('쿠폰이 선택한 회원에게 발급되었습니다.');
                            loadIssuedCoupons();
                        })
                        .catch(error => {
                            console.error('Error issuing coupon to member:', error);
                            alert(error.message);
                        });
                }
            }

            // 쿠폰 삭제 함수
            function deleteCoupon() {
                fetch(`/api/coupons/${couponId}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('쿠폰 삭제에 실패했습니다.');
                        }

                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteCouponModal'));
                        modal.hide();
                        alert('쿠폰이 삭제되었습니다.');
                        window.location.href = '/admin/coupons';
                    })
                    .catch(error => {
                        console.error('Error deleting coupon:', error);
                        alert(error.message);
                    });
            }

            // 쿠폰 사용 취소 함수
            function cancelUsedCoupon() {
                const memberCouponId = document.getElementById('cancelMemberCouponId').value;

                fetch(`/api/coupons/member-coupon/${memberCouponId}/cancel`, {
                    method: 'POST'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('쿠폰 사용 취소에 실패했습니다.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('cancelCouponModal'));
                        modal.hide();
                        alert('쿠폰 사용이 취소되었습니다.');
                        loadIssuedCoupons();
                    })
                    .catch(error => {
                        console.error('Error canceling coupon usage:', error);
                        alert(error.message);
                    });
            }

            // 발급된 쿠폰 엑셀 내보내기 함수
            function exportIssuedCoupons() {
                const memberKeyword = document.getElementById('memberSearchKeyword').value;
                const usageStatus = document.getElementById('usageStatusFilter').value;

                let url = `/api/coupons/${couponId}/issued/export`;
                let params = [];

                if (memberKeyword) {
                    params.push(`memberKeyword=${encodeURIComponent(memberKeyword)}`);
                }

                if (usageStatus) {
                    params.push(`status=${usageStatus}`);
                }

                if (params.length > 0) {
                    url += '?' + params.join('&');
                }

                window.location.href = url;
            }

            // 회원 검색 함수
            function searchMembers() {
                const keyword = document.getElementById('memberSearchKeyword').value;
                if (!keyword) {
                    alert('검색어를 입력해주세요.');
                    return;
                }

                fetch(`/api/members/search?keyword=${encodeURIComponent(keyword)}`)
                    .then(response => response.json())
                    .then(data => {
                        const resultsDiv = document.getElementById('memberSearchResults');
                        resultsDiv.innerHTML = '';

                        if (data.content && data.content.length > 0) {
                            const ul = document.createElement('ul');
                            ul.className = 'list-group';

                            data.content.forEach(member => {
                                const li = document.createElement('li');
                                li.className = 'list-group-item list-group-item-action';
                                li.innerHTML = `${member.name} (${member.email})`;
                                li.addEventListener('click', function() {
                                    selectMember(member.id, member.name, member.email);
                                });
                                ul.appendChild(li);
                            });

                            resultsDiv.appendChild(ul);
                        } else {
                            resultsDiv.innerHTML = '<div class="alert alert-warning">검색 결과가 없습니다.</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error searching members:', error);
                        alert('회원 검색 중 오류가 발생했습니다.');
                    });
            }

            // 회원 선택 함수
            function selectMember(id, name, email) {
                document.getElementById('selectedMemberId').value = id;
                document.getElementById('selectedMemberName').textContent = name;
                document.getElementById('selectedMemberEmail').textContent = email;
                document.getElementById('selectedMemberInfo').style.display = 'block';
                document.getElementById('memberSearchResults').innerHTML = '';
            }

            // 날짜 포맷팅 함수
            function formatDateTime(dateTimeStr) {
                if (!dateTimeStr) return '-';
                const date = new Date(dateTimeStr);
                return date.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }

            // 날짜를 input datetime-local 형식으로 변환
            function formatDateForInput(dateTimeStr) {
                if (!dateTimeStr) return '';
                const date = new Date(dateTimeStr);
                return date.toISOString().slice(0, 16);
            }

            // 전역 함수 등록
            window.cancelCoupon = function(id, memberName, orderId) {
                document.getElementById('cancelMemberCouponId').value = id;
                document.getElementById('cancelMemberName').textContent = memberName;
                document.getElementById('cancelOrderId').textContent = orderId || '없음';

                const modal = new bootstrap.Modal(document.getElementById('cancelCouponModal'));
                modal.show();
            };
        });
    </script>
</div>
</body>
</html>

