<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">
<head>
    <title>상품 등록/수정</title>
    <th:block layout:fragment="css">
        <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
        <style>
            .preview-image {
                width: 100px;
                height: 100px;
                object-fit: cover;
                border-radius: 5px;
                margin-right: 10px;
                margin-bottom: 10px;
            }
            .image-preview-container {
                display: flex;
                flex-wrap: wrap;
                margin-top: 10px;
            }
            .remove-image-btn {
                position: absolute;
                top: 0;
                right: 0;
                background-color: rgba(255, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                font-size: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            }
            .image-preview-item {
                position: relative;
                display: inline-block;
            }
            .note-editor {
                margin-bottom: 20px;
            }
        </style>
    </th:block>
</head>
<body>
<!-- 페이지 제목 -->
<h1 layout:fragment="page-title" th:text="${product != null ? '상품 수정' : '상품 등록'}">상품 등록/수정</h1>

<!-- 페이지 내용 -->
<div layout:fragment="content">
    <div class="admin-card mb-4">
        <form id="productForm" th:action="${product != null ? '/admin/products/update' : '/admin/products/save'}" method="post" enctype="multipart/form-data">
            <input type="hidden" name="id" th:if="${product != null}" th:value="${product.id}">

            <div class="row mb-4">
                <div class="col-md-8">
                    <!-- 기본 정보 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">기본 정보</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="productName" class="form-label">상품명 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productName" name="name" required th:value="${product != null ? product.name : ''}">
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="productCode" class="form-label">상품코드 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="productCode" name="code" required th:value="${product != null ? product.code : ''}">
                                </div>
                                <div class="col-md-6">
                                    <label for="productCategory" class="form-label">카테고리 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="productCategory" name="categoryId" required>
                                        <option value="" selected disabled>카테고리 선택</option>
                                        <option value="1" th:selected="${product != null && product.categoryId == 1}">의류</option>
                                        <option value="2" th:selected="${product != null && product.categoryId == 2}">신발</option>
                                        <option value="3" th:selected="${product != null && product.categoryId == 3}">액세서리</option>
                                        <option value="4" th:selected="${product != null && product.categoryId == 4}">스포츠용품</option>
                                        <option value="5" th:selected="${product != null && product.categoryId == 5}">아웃도어</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="productPrice" class="form-label">판매가격 <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text">₩</span>
                                        <input type="number" class="form-control" id="productPrice" name="price" required th:value="${product != null ? product.price : ''}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="productCostPrice" class="form-label">원가</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₩</span>
                                        <input type="number" class="form-control" id="productCostPrice" name="costPrice" th:value="${product != null ? product.costPrice : ''}">
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="productStock" class="form-label">재고수량 <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="productStock" name="stock" required th:value="${product != null ? product.stock : ''}">
                                </div>
                                <div class="col-md-6">
                                    <label for="productStatus" class="form-label">판매상태 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="productStatus" name="status" required>
                                        <option value="ACTIVE" th:selected="${product != null && product.status == 'ACTIVE'}">판매중</option>
                                        <option value="OUT_OF_STOCK" th:selected="${product != null && product.status == 'OUT_OF_STOCK'}">품절</option>
                                        <option value="INACTIVE" th:selected="${product != null && product.status == 'INACTIVE'}">판매중지</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="productSummary" class="form-label">상품 요약</label>
                                <textarea class="form-control" id="productSummary" name="summary" rows="2" th:text="${product != null ? product.summary : ''}"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 상세 정보 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">상세 정보</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="productDescription" class="form-label">상품 상세설명</label>
                                <textarea id="productDescription" name="description" th:text="${product != null ? product.description : ''}"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 배송 정보 -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">배송 정보</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="shippingMethod" class="form-label">배송방법</label>
                                    <select class="form-select" id="shippingMethod" name="shippingMethod">
                                        <option value="STANDARD" th:selected="${product != null && product.shippingMethod == 'STANDARD'}">일반배송</option>
                                        <option value="EXPRESS" th:selected="${product != null && product.shippingMethod == 'EXPRESS'}">특급배송</option>
                                        <option value="FREE" th:selected="${product != null && product.shippingMethod == 'FREE'}">무료배송</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="shippingFee" class="form-label">배송비</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₩</span>
                                        <input type="number" class="form-control" id="shippingFee" name="shippingFee" th:value="${product != null ? product.shippingFee : '3000'}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- 이미지 업로드 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">상품 이미지</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="productImages" class="form-label">이미지 업로드 (최대 5개)</label>
                                <input type="file" class="form-control" id="productImages" name="images" multiple accept="image/*">
                                <div class="form-text">권장 크기: 800x800px, 최대 5MB</div>
                            </div>
                            <div class="image-preview-container" id="imagePreviewContainer">
                                <!-- 기존 이미지가 있는 경우 표시 -->
                                <div th:if="${product != null && product.images != null}" th:each="image : ${product.images}" class="image-preview-item">
                                    <img th:src="${image.url}" class="preview-image">
                                    <button type="button" class="remove-image-btn" th:data-id="${image.id}">&times;</button>
                                    <input type="hidden" name="existingImageIds" th:value="${image.id}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 옵션 설정 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">옵션 설정</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="hasOptions" name="hasOptions" th:checked="${product != null && product.hasOptions}">
                                    <label class="form-check-label" for="hasOptions">옵션 사용</label>
                                </div>
                            </div>
                            <div id="optionsContainer" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">옵션 유형</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="optionSize" name="optionTypes" value="SIZE" th:checked="${product != null && product.optionTypes != null && product.optionTypes.contains('SIZE')}">
                                        <label class="form-check-label" for="optionSize">사이즈</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="optionColor" name="optionTypes" value="COLOR" th:checked="${product != null && product.optionTypes != null && product.optionTypes.contains('COLOR')}">
                                        <label class="form-check-label" for="optionColor">색상</label>
                                    </div>
                                </div>
                                <div class="mb-3" id="sizeOptionsContainer" style="display: none;">
                                    <label for="sizeOptions" class="form-label">사이즈 옵션 (쉼표로 구분)</label>
                                    <input type="text" class="form-control" id="sizeOptions" name="sizeOptions" placeholder="S, M, L, XL" th:value="${product != null ? product.sizeOptions : ''}">
                                </div>
                                <div class="mb-3" id="colorOptionsContainer" style="display: none;">
                                    <label for="colorOptions" class="form-label">색상 옵션 (쉼표로 구분)</label>
                                    <input type="text" class="form-control" id="colorOptions" name="colorOptions" placeholder="빨강, 파랑, 검정" th:value="${product != null ? product.colorOptions : ''}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 태그 설정 -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">태그 설정</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="productTags" class="form-label">태그 (쉼표로 구분)</label>
                                <input type="text" class="form-control" id="productTags" name="tags" placeholder="스포츠, 여름, 신상품" th:value="${product != null ? product.tags : ''}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 저장 버튼 -->
            <div class="d-flex justify-content-end">
                <a th:href="@{/admin/products}" class="btn btn-secondary me-2">취소</a>
                <button type="submit" class="btn btn-primary">저장</button>
            </div>
        </form>
    </div>
</div>

<!-- 페이지별 스크립트 -->
<th:block layout:fragment="page-script">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-ko-KR.min.js"></script>
    <script>
        $(document).ready(function() {
            // 상세 설명 에디터 초기화
            $('#productDescription').summernote({
                height: 300,
                lang: 'ko-KR',
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'underline', 'clear']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['insert', ['link', 'picture']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ]
            });

            // 옵션 사용 체크박스 이벤트
            $('#hasOptions').change(function() {
                if(this.checked) {
                    $('#optionsContainer').show();
                } else {
                    $('#optionsContainer').hide();
                }
            });

            // 초기 옵션 상태 설정
            if($('#hasOptions').is(':checked')) {
                $('#optionsContainer').show();
            }

            // 사이즈 옵션 체크박스 이벤트
            $('#optionSize').change(function() {
                if(this.checked) {
                    $('#sizeOptionsContainer').show();
                } else {
                    $('#sizeOptionsContainer').hide();
                }
            });

            // 색상 옵션 체크박스 이벤트
            $('#optionColor').change(function() {
                if(this.checked) {
                    $('#colorOptionsContainer').show();
                } else {
                    $('#colorOptionsContainer').hide();
                }
            });

            // 초기 옵션 유형 상태 설정
            if($('#optionSize').is(':checked')) {
                $('#sizeOptionsContainer').show();
            }

            if($('#optionColor').is(':checked')) {
                $('#colorOptionsContainer').show();
            }

            // 이미지 미리보기
            $('#productImages').change(function() {
                const files = this.files;
                $('#imagePreviewContainer').empty();

                for(let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        const previewItem = $('<div class="image-preview-item"></div>');
                        const img = $('<img class="preview-image">').attr('src', e.target.result);
                        const removeBtn = $('<button type="button" class="remove-image-btn">&times;</button>');

                        removeBtn.click(function() {
                            previewItem.remove();
                        });

                        previewItem.append(img);
                        previewItem.append(removeBtn);
                        $('#imagePreviewContainer').append(previewItem);
                    }

                    reader.readAsDataURL(file);
                }
            });

            // 기존 이미지 삭제 버튼 이벤트
            $('.remove-image-btn').click(function() {
                $(this).parent().remove();
            });
        });
    </script>
</th:block>
</body>
</html>
