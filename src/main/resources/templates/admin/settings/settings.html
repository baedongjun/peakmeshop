<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">

<head>
    <title>설정 관리 - Peak Me Shop 관리자</title>
    <style>
        /* 탭 스타일 */
        .nav-tabs .nav-link {
            color: #6c757d;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            font-weight: 600;
        }
        
        /* 폼 스타일 */
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .input-group-text {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        
        /* 체크박스 스타일 */
        .form-check {
            margin-bottom: 0.5rem;
        }
        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        
        /* 버튼 스타일 */
        .btn-primary {
            padding: 0.5rem 2rem;
            font-weight: 500;
        }
        .btn-outline-secondary {
            border-color: #ced4da;
        }
        .btn-outline-secondary:hover {
            background-color: #f8f9fa;
            border-color: #0d6efd;
            color: #0d6efd;
        }
        
        /* 카드 스타일 */
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .card-header {
            background-color: #fff;
            border-bottom: none;
            padding-bottom: 0;
        }
        .card-body {
            padding: 2rem;
        }
        
        /* 반응형 조정 */
        @media (max-width: 768px) {
            .card-body {
                padding: 1rem;
            }
            .btn-primary {
                width: 100%;
                margin-top: 1rem;
            }
        }
        
        /* 애니메이션 효과 */
        .tab-pane {
            transition: all 0.3s ease-in-out;
        }
        .tab-pane.fade {
            opacity: 0;
            transform: translateY(10px);
        }
        .tab-pane.fade.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 입력 필드 그룹 스타일 */
        .input-group {
            margin-bottom: 1rem;
        }
        .input-group .form-control {
            border-right: none;
        }
        .input-group .input-group-text {
            border-left: none;
            background-color: #fff;
        }
        
        /* 텍스트 영역 스타일 */
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        /* 필수 입력 필드 표시 */
        .form-label.required::after {
            content: "*";
            color: #dc3545;
            margin-left: 4px;
        }
        
        /* 저장 버튼 컨테이너 */
        .save-button-container {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
            text-align: center;
        }
        
        /* 토스트 메시지 스타일 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .toast {
            min-width: 300px;
        }
        .toast-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .toast-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <div class="container-fluid px-4">
            <h1 class="mt-4">설정 관리</h1>
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item"><a href="/admin">대시보드</a></li>
                <li class="breadcrumb-item active">설정 관리</li>
            </ol>

            <!-- 설정 탭 -->
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#basicSettings">
                                기본 설정
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#paymentSettings">
                                결제 설정
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#deliverySettings">
                                배송 설정
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#pointSettings">
                                포인트/적립금 설정
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#smsSettings">
                                SMS 설정
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- 기본 설정 -->
                        <div class="tab-pane fade show active" id="basicSettings">
                            <form id="basicSettingsForm" class="row g-3">
                                <div class="col-md-6">
                                    <label for="shopName" class="form-label">쇼핑몰 이름</label>
                                    <input type="text" class="form-control" id="shopName" name="shopName" 
                                           th:value="${settings.basic.shopName}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="adminEmail" class="form-label">관리자 이메일</label>
                                    <input type="email" class="form-control" id="adminEmail" name="adminEmail" 
                                           th:value="${settings.basic.adminEmail}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="customerServicePhone" class="form-label">고객센터 전화번호</label>
                                    <input type="tel" class="form-control" id="customerServicePhone" name="customerServicePhone" 
                                           th:value="${settings.basic.customerServicePhone}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="customerServiceHours" class="form-label">고객센터 운영시간</label>
                                    <input type="text" class="form-control" id="customerServiceHours" name="customerServiceHours" 
                                           th:value="${settings.basic.customerServiceHours}" required>
                                </div>
                                <div class="col-12">
                                    <label for="companyInfo" class="form-label">회사 정보</label>
                                    <textarea class="form-control" id="companyInfo" name="companyInfo" rows="3" 
                                              th:text="${settings.basic.companyInfo}" required></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="termsOfService" class="form-label">이용약관</label>
                                    <textarea class="form-control" id="termsOfService" name="termsOfService" rows="5" 
                                              th:text="${settings.basic.termsOfService}" required></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="privacyPolicy" class="form-label">개인정보처리방침</label>
                                    <textarea class="form-control" id="privacyPolicy" name="privacyPolicy" rows="5" 
                                              th:text="${settings.basic.privacyPolicy}" required></textarea>
                                </div>
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary" onclick="saveSettings('basic')">저장</button>
                                </div>
                            </form>
                        </div>

                        <!-- 결제 설정 -->
                        <div class="tab-pane fade" id="paymentSettings">
                            <form id="paymentSettingsForm" class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">결제 수단</label>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="creditCard" name="paymentMethods" 
                                               value="CREDIT_CARD" th:checked="${settings.payment.creditCardEnabled}">
                                        <label class="form-check-label" for="creditCard">신용카드</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="bankTransfer" name="paymentMethods" 
                                               value="BANK_TRANSFER" th:checked="${settings.payment.bankTransferEnabled}">
                                        <label class="form-check-label" for="bankTransfer">계좌이체</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="virtualAccount" name="paymentMethods" 
                                               value="VIRTUAL_ACCOUNT" th:checked="${settings.payment.virtualAccountEnabled}">
                                        <label class="form-check-label" for="virtualAccount">가상계좌</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="mobilePay" name="paymentMethods" 
                                               value="MOBILE_PAY" th:checked="${settings.payment.mobilePayEnabled}">
                                        <label class="form-check-label" for="mobilePay">휴대폰 결제</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="minOrderAmount" class="form-label">최소 주문금액</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="minOrderAmount" name="minOrderAmount" 
                                               th:value="${settings.payment.minOrderAmount}" required>
                                        <span class="input-group-text">원</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="pgProvider" class="form-label">PG사 설정</label>
                                    <select class="form-select" id="pgProvider" name="pgProvider">
                                        <option value="INICIS" th:selected="${settings.payment.pgProvider == 'INICIS'}">KG이니시스</option>
                                        <option value="NICE" th:selected="${settings.payment.pgProvider == 'NICE'}">나이스페이</option>
                                        <option value="TOSS" th:selected="${settings.payment.pgProvider == 'TOSS'}">토스페이먼츠</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="pgMerchantId" class="form-label">상점 아이디</label>
                                    <input type="text" class="form-control" id="pgMerchantId" name="pgMerchantId" 
                                           th:value="${settings.payment.pgMerchantId}">
                                </div>
                                <div class="col-md-6">
                                    <label for="pgSecretKey" class="form-label">시크릿 키</label>
                                    <input type="password" class="form-control" id="pgSecretKey" name="pgSecretKey" 
                                           placeholder="변경시에만 입력">
                                </div>
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary" onclick="saveSettings('payment')">저장</button>
                                </div>
                            </form>
                        </div>

                        <!-- 배송 설정 -->
                        <div class="tab-pane fade" id="deliverySettings">
                            <form id="deliverySettingsForm" class="row g-3">
                                <div class="col-md-6">
                                    <label for="defaultDeliveryFee" class="form-label">기본 배송비</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="defaultDeliveryFee" name="defaultDeliveryFee" 
                                               th:value="${settings.delivery.defaultDeliveryFee}" required>
                                        <span class="input-group-text">원</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="freeDeliveryThreshold" class="form-label">무료배송 기준금액</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="freeDeliveryThreshold" name="freeDeliveryThreshold" 
                                               th:value="${settings.delivery.freeDeliveryThreshold}" required>
                                        <span class="input-group-text">원</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="defaultDeliveryCompany" class="form-label">기본 배송업체</label>
                                    <select class="form-select" id="defaultDeliveryCompany" name="defaultDeliveryCompany">
                                        <option value="CJ" th:selected="${settings.delivery.defaultDeliveryCompany == 'CJ'}">CJ대한통운</option>
                                        <option value="LOTTE" th:selected="${settings.delivery.defaultDeliveryCompany == 'LOTTE'}">롯데택배</option>
                                        <option value="HANJIN" th:selected="${settings.delivery.defaultDeliveryCompany == 'HANJIN'}">한진택배</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">반품 주소</label>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="returnZipcode" name="returnZipcode" 
                                                       th:value="${settings.delivery.returnZipcode}" readonly>
                                                <button type="button" class="btn btn-outline-secondary" onclick="searchAddress()">
                                                    주소 검색
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <input type="text" class="form-control" id="returnAddress1" name="returnAddress1" 
                                                   th:value="${settings.delivery.returnAddress1}" readonly>
                                        </div>
                                        <div class="col-12">
                                            <input type="text" class="form-control" id="returnAddress2" name="returnAddress2" 
                                                   th:value="${settings.delivery.returnAddress2}" placeholder="상세주소">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary" onclick="saveSettings('delivery')">저장</button>
                                </div>
                            </form>
                        </div>

                        <!-- 포인트/적립금 설정 -->
                        <div class="tab-pane fade" id="pointSettings">
                            <form id="pointSettingsForm" class="row g-3">
                                <div class="col-md-6">
                                    <label for="pointRate" class="form-label">적립률</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="pointRate" name="pointRate" 
                                               th:value="${settings.point.pointRate}" min="0" max="100" step="0.1" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="minPointAmount" class="form-label">최소 적립금액</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="minPointAmount" name="minPointAmount" 
                                               th:value="${settings.point.minPointAmount}" required>
                                        <span class="input-group-text">원</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="signupPoint" class="form-label">회원가입 포인트</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="signupPoint" name="signupPoint" 
                                               th:value="${settings.point.signupPoint}" required>
                                        <span class="input-group-text">P</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="reviewPoint" class="form-label">리뷰작성 포인트</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="reviewPoint" name="reviewPoint" 
                                               th:value="${settings.point.reviewPoint}" required>
                                        <span class="input-group-text">P</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary" onclick="saveSettings('point')">저장</button>
                                </div>
                            </form>
                        </div>

                        <!-- SMS 설정 -->
                        <div class="tab-pane fade" id="smsSettings">
                            <form id="smsSettingsForm" class="row g-3">
                                <div class="col-md-6">
                                    <label for="smsProvider" class="form-label">SMS 서비스</label>
                                    <select class="form-select" id="smsProvider" name="smsProvider">
                                        <option value="ALIGO" th:selected="${settings.sms.smsProvider == 'ALIGO'}">알리고</option>
                                        <option value="COOLSMS" th:selected="${settings.sms.smsProvider == 'COOLSMS'}">쿨SMS</option>
                                        <option value="NCLOUD" th:selected="${settings.sms.smsProvider == 'NCLOUD'}">네이버클라우드</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="smsApiKey" class="form-label">API Key</label>
                                    <input type="password" class="form-control" id="smsApiKey" name="smsApiKey" 
                                           placeholder="변경시에만 입력">
                                </div>
                                <div class="col-md-6">
                                    <label for="smsApiSecret" class="form-label">API Secret</label>
                                    <input type="password" class="form-control" id="smsApiSecret" name="smsApiSecret" 
                                           placeholder="변경시에만 입력">
                                </div>
                                <div class="col-md-6">
                                    <label for="smsSenderId" class="form-label">발신번호</label>
                                    <input type="text" class="form-control" id="smsSenderId" name="smsSenderId" 
                                           th:value="${settings.sms.smsSenderId}">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">알림 설정</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="orderSmsEnabled" 
                                                       name="orderSmsEnabled" th:checked="${settings.sms.orderSmsEnabled}">
                                                <label class="form-check-label" for="orderSmsEnabled">
                                                    주문 관련 알림
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="deliverySmsEnabled" 
                                                       name="deliverySmsEnabled" th:checked="${settings.sms.deliverySmsEnabled}">
                                                <label class="form-check-label" for="deliverySmsEnabled">
                                                    배송 관련 알림
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="pointSmsEnabled" 
                                                       name="pointSmsEnabled" th:checked="${settings.sms.pointSmsEnabled}">
                                                <label class="form-check-label" for="pointSmsEnabled">
                                                    포인트 관련 알림
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="marketingSmsEnabled" 
                                                       name="marketingSmsEnabled" th:checked="${settings.sms.marketingSmsEnabled}">
                                                <label class="form-check-label" for="marketingSmsEnabled">
                                                    마케팅 알림
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary" onclick="saveSettings('sms')">저장</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 자바스크립트 -->
    <th:block layout:fragment="script">
        <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
        <script th:inline="javascript">
            // 공통 유효성 검사 규칙
            const validationRules = {
                shopName: {
                    minLength: 2,
                    maxLength: 50,
                    pattern: /^[가-힣a-zA-Z0-9\s]+$/,
                    message: '쇼핑몰 이름은 2~50자의 한글, 영문, 숫자만 가능합니다.'
                },
                email: {
                    pattern: /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,
                    message: '올바른 이메일 주소를 입력해주세요.'
                },
                phone: {
                    pattern: /^(\d{2,3})-?(\d{3,4})-?(\d{4})$/,
                    message: '올바른 전화번호 형식으로 입력해주세요. (예: 02-1234-5678)'
                },
                zipcode: {
                    pattern: /^\d{5}$/,
                    message: '올바른 우편번호를 입력해주세요.'
                },
                price: {
                    min: 0,
                    max: 1000000000,
                    message: '금액은 0원 이상 10억원 이하로 입력해주세요.'
                },
                point: {
                    min: 0,
                    max: 1000000,
                    message: '포인트는 0P 이상 100만P 이하로 입력해주세요.'
                },
                rate: {
                    min: 0,
                    max: 100,
                    message: '비율은 0% 이상 100% 이하로 입력해주세요.'
                }
            };

            // 실시간 유효성 검사 함수
            function validateField(field) {
                const value = field.value;
                let rule;

                // 필드 타입에 따른 규칙 선택
                switch (field.id) {
                    case 'shopName':
                        rule = validationRules.shopName;
                        break;
                    case 'adminEmail':
                        rule = validationRules.email;
                        break;
                    case 'customerServicePhone':
                    case 'smsSenderId':
                        rule = validationRules.phone;
                        break;
                    case 'returnZipcode':
                        rule = validationRules.zipcode;
                        break;
                    case 'minOrderAmount':
                    case 'defaultDeliveryFee':
                    case 'freeDeliveryThreshold':
                        rule = validationRules.price;
                        break;
                    case 'signupPoint':
                    case 'reviewPoint':
                    case 'minPointAmount':
                        rule = validationRules.point;
                        break;
                    case 'pointRate':
                        rule = validationRules.rate;
                        break;
                }

                // 유효성 검사 수행
                if (rule) {
                    let isValid = true;
                    let errorMessage = '';

                    // 길이 검사
                    if (rule.minLength && value.length < rule.minLength) {
                        isValid = false;
                        errorMessage = `최소 ${rule.minLength}자 이상 입력해주세요.`;
                    }
                    if (rule.maxLength && value.length > rule.maxLength) {
                        isValid = false;
                        errorMessage = `최대 ${rule.maxLength}자까지 입력 가능합니다.`;
                    }

                    // 패턴 검사
                    if (rule.pattern && !rule.pattern.test(value)) {
                        isValid = false;
                        errorMessage = rule.message;
                    }

                    // 범위 검사
                    if (rule.min !== undefined && parseFloat(value) < rule.min) {
                        isValid = false;
                        errorMessage = rule.message;
                    }
                    if (rule.max !== undefined && parseFloat(value) > rule.max) {
                        isValid = false;
                        errorMessage = rule.message;
                    }

                    // 피드백 표시
                    const feedbackDiv = field.nextElementSibling;
                    if (!feedbackDiv || !feedbackDiv.classList.contains('invalid-feedback')) {
                        const div = document.createElement('div');
                        div.className = 'invalid-feedback';
                        field.parentNode.insertBefore(div, field.nextSibling);
                    }

                    if (!isValid) {
                        field.classList.add('is-invalid');
                        field.classList.remove('is-valid');
                        field.nextElementSibling.textContent = errorMessage;
                    } else {
                        field.classList.remove('is-invalid');
                        field.classList.add('is-valid');
                        field.nextElementSibling.textContent = '';
                    }

                    return isValid;
                }

                return true;
            }

            // 기존 validateForm 함수 수정
            function validateForm(type) {
                const form = document.getElementById(type + 'SettingsForm');
                let isValid = true;

                // 모든 입력 필드 검사
                form.querySelectorAll('input, select, textarea').forEach(field => {
                    if (!validateField(field)) {
                        isValid = false;
                    }
                });

                if (!isValid) {
                    return false;
                }

                // 추가 유효성 검사
                switch (type) {
                    case 'basic':
                        return validateBasicSettings();
                    case 'payment':
                        return validatePaymentSettings();
                    case 'delivery':
                        return validateDeliverySettings();
                    case 'point':
                        return validatePointSettings();
                    case 'sms':
                        return validateSmsSettings();
                }

                return true;
            }

            // 토스트 메시지 표시 함수
            function showToast(message, type = 'success') {
                const toastContainer = document.querySelector('.toast-container');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type} show`;
                toast.innerHTML = `
                    <div class="toast-header">
                        <strong class="me-auto">${type === 'success' ? '성공' : '오류'}</strong>
                        <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                `;
                toastContainer.appendChild(toast);
                
                // 3초 후 자동으로 닫기
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // API 응답 처리 함수
            async function handleApiResponse(response, successMessage) {
                if (!response.ok) {
                    let errorMessage = '설정 저장에 실패했습니다.';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    showToast(errorMessage, 'error');
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                showToast(successMessage);
                return data;
            }

            // 설정 저장 함수 수정
            async function saveSettings(type) {
                try {
                    if (!validateForm(type)) {
                        return;
                    }

                    const form = document.getElementById(type + 'SettingsForm');
                    const formData = new FormData(form);
                    const settings = {};

                    formData.forEach((value, key) => {
                        settings[key] = value;
                    });

                    // 체크박스 처리
                    if (type === 'payment') {
                        ['creditCard', 'bankTransfer', 'virtualAccount', 'mobilePay'].forEach(id => {
                            settings[id + 'Enabled'] = document.getElementById(id).checked;
                        });
                    }
                    if (type === 'sms') {
                        ['orderSms', 'deliverySms', 'pointSms', 'marketingSms'].forEach(id => {
                            settings[id + 'Enabled'] = document.getElementById(id).checked;
                        });
                    }

                    // 저장 버튼 비활성화 및 로딩 표시
                    const saveButton = form.querySelector('button[type="button"]');
                    const originalText = saveButton.textContent;
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 저장 중...';

                    try {
                        const response = await fetch(`/api/settings/${type}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(settings)
                        });

                        await handleApiResponse(response, '설정이 성공적으로 저장되었습니다.');
                    } finally {
                        // 저장 버튼 상태 복구
                        saveButton.disabled = false;
                        saveButton.textContent = originalText;
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }

            // 주소 검색 함수
            function searchAddress() {
                new daum.Postcode({
                    oncomplete: function(data) {
                        document.getElementById('returnZipcode').value = data.zonecode;
                        document.getElementById('returnAddress1').value = data.address;
                        document.getElementById('returnAddress2').focus();
                    }
                }).open();
            }

            // 기본 설정 유효성 검사
            function validateBasicSettings() {
                const email = document.getElementById('adminEmail').value;
                const phone = document.getElementById('customerServicePhone').value;

                // 이메일 형식 검사
                const emailRegex = /^[A-Za-z0-9+_.-]+@(.+)$/;
                if (!emailRegex.test(email)) {
                    alert('올바른 이메일 주소를 입력해주세요.');
                    return false;
                }

                // 전화번호 형식 검사
                const phoneRegex = /^[0-9-]+$/;
                if (!phoneRegex.test(phone)) {
                    alert('올바른 전화번호를 입력해주세요.');
                    return false;
                }

                return true;
            }

            // 결제 설정 유효성 검사
            function validatePaymentSettings() {
                const minOrderAmount = document.getElementById('minOrderAmount').value;
                
                if (minOrderAmount < 0) {
                    alert('최소 주문금액은 0원 이상이어야 합니다.');
                    return false;
                }

                // 하나 이상의 결제 수단이 선택되어야 함
                const paymentMethods = ['creditCard', 'bankTransfer', 'virtualAccount', 'mobilePay'];
                if (!paymentMethods.some(id => document.getElementById(id).checked)) {
                    alert('하나 이상의 결제 수단을 선택해주세요.');
                    return false;
                }

                return true;
            }

            // 배송 설정 유효성 검사
            function validateDeliverySettings() {
                const defaultDeliveryFee = document.getElementById('defaultDeliveryFee').value;
                const freeDeliveryThreshold = document.getElementById('freeDeliveryThreshold').value;

                if (defaultDeliveryFee < 0) {
                    alert('기본 배송비는 0원 이상이어야 합니다.');
                    return false;
                }

                if (freeDeliveryThreshold < 0) {
                    alert('무료배송 기준금액은 0원 이상이어야 합니다.');
                    return false;
                }

                return true;
            }

            // 포인트 설정 유효성 검사
            function validatePointSettings() {
                const pointRate = document.getElementById('pointRate').value;
                const minPointAmount = document.getElementById('minPointAmount').value;
                const signupPoint = document.getElementById('signupPoint').value;
                const reviewPoint = document.getElementById('reviewPoint').value;

                if (pointRate < 0 || pointRate > 100) {
                    alert('적립률은 0~100% 사이여야 합니다.');
                    return false;
                }

                if (minPointAmount < 0) {
                    alert('최소 적립금액은 0원 이상이어야 합니다.');
                    return false;
                }

                if (signupPoint < 0) {
                    alert('회원가입 포인트는 0P 이상이어야 합니다.');
                    return false;
                }

                if (reviewPoint < 0) {
                    alert('리뷰작성 포인트는 0P 이상이어야 합니다.');
                    return false;
                }

                return true;
            }

            // SMS 설정 유효성 검사
            function validateSmsSettings() {
                const smsProvider = document.getElementById('smsProvider').value;
                const smsApiKey = document.getElementById('smsApiKey').value;
                const smsApiSecret = document.getElementById('smsApiSecret').value;
                const smsSenderId = document.getElementById('smsSenderId').value;

                if (document.getElementById('orderSmsEnabled').checked || 
                    document.getElementById('deliverySmsEnabled').checked ||
                    document.getElementById('pointSmsEnabled').checked ||
                    document.getElementById('marketingSmsEnabled').checked) {
                    if (!smsProvider) {
                        alert('SMS 제공업체를 입력해주세요.');
                        return false;
                    }
                    if (!smsApiKey) {
                        alert('API 키를 입력해주세요.');
                        return false;
                    }
                    if (!smsApiSecret) {
                        alert('API Secret을 입력해주세요.');
                        return false;
                    }
                    if (!smsSenderId) {
                        alert('발신자 번호를 입력해주세요.');
                        return false;
                    }
                }

                return true;
            }

            // 실시간 유효성 검사 이벤트 리스너 등록
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('input, select, textarea').forEach(field => {
                    field.addEventListener('input', function() {
                        validateField(this);
                    });
                    field.addEventListener('blur', function() {
                        validateField(this);
                    });
                });
            });

            // 탭 전환 시 애니메이션 효과 추가
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    
                    // 모든 탭 비활성화
                    document.querySelectorAll('.nav-link').forEach(navLink => {
                        navLink.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                        pane.style.opacity = '0';
                        pane.style.transform = 'translateY(10px)';
                    });
                    
                    // 선택된 탭 활성화
                    this.classList.add('active');
                    const targetPane = document.querySelector(targetId);
                    targetPane.classList.add('show', 'active');
                    
                    // 애니메이션 효과
                    setTimeout(() => {
                        targetPane.style.opacity = '1';
                        targetPane.style.transform = 'translateY(0)';
                    }, 150);
                });
            });
            
            // 필수 입력 필드 레이블 표시
            document.querySelectorAll('input[required], select[required], textarea[required]').forEach(field => {
                const label = document.querySelector(`label[for="${field.id}"]`);
                if (label) {
                    label.classList.add('required');
                }
            });
            
            // 숫자 입력 필드 포맷팅 개선
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', function(e) {
                    const value = this.value.replace(/[^0-9.]/g, '');
                    if (value) {
                        if (this.id === 'pointRate') {
                            // 소수점 한 자리까지만 허용
                            this.value = parseFloat(value).toFixed(1);
                        } else {
                            // 정수 값에 천단위 콤마 추가
                            this.value = parseInt(value).toLocaleString();
                        }
                    }
                });
                
                // 초기값 포맷팅
                if (input.value) {
                    const event = new Event('input');
                    input.dispatchEvent(event);
                }
            });
            
            // 저장 버튼 컨테이너 추가
            document.querySelectorAll('form').forEach(form => {
                const submitButton = form.querySelector('button[type="button"]');
                if (submitButton) {
                    const container = document.createElement('div');
                    container.className = 'save-button-container';
                    submitButton.parentNode.replaceChild(container, submitButton);
                    container.appendChild(submitButton);
                }
            });
        </script>
    </th:block>
    <div class="toast-container"></div>
</body>
</html> 