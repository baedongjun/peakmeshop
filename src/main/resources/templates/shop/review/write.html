<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop-layout}">
<head>
    <title>리뷰 작성 - PeakMeShop</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container py-5">
            <h2 class="mb-4">상품 리뷰 작성</h2>

            <!-- 상품 정보 -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <img th:src="${order.product.mainImage}" alt="상품 이미지" 
                                 class="img-thumbnail" style="width: 100px;">
                        </div>
                        <div class="col">
                            <p class="text-muted small mb-1" th:text="${order.product.brand?.name}">브랜드</p>
                            <h5 class="mb-1" th:text="${order.product.name}">상품명</h5>
                            <p class="text-muted small mb-0" th:if="${order.productOption != null}"
                               th:text="${order.productOption}">옵션</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 리뷰 작성 폼 -->
            <form th:action="@{/reviews}" method="post" enctype="multipart/form-data" id="reviewForm">
                <input type="hidden" name="orderId" th:value="${order.id}">
                <input type="hidden" name="productId" th:value="${order.product.id}">
                
                <!-- 별점 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">별점</h5>
                    </div>
                    <div class="card-body">
                        <div class="rating-stars d-flex align-items-center">
                            <div class="stars">
                                <input type="radio" name="rating" value="5" id="star5" required>
                                <label for="star5"><i class="bi bi-star-fill"></i></label>
                                <input type="radio" name="rating" value="4" id="star4">
                                <label for="star4"><i class="bi bi-star-fill"></i></label>
                                <input type="radio" name="rating" value="3" id="star3">
                                <label for="star3"><i class="bi bi-star-fill"></i></label>
                                <input type="radio" name="rating" value="2" id="star2">
                                <label for="star2"><i class="bi bi-star-fill"></i></label>
                                <input type="radio" name="rating" value="1" id="star1">
                                <label for="star1"><i class="bi bi-star-fill"></i></label>
                            </div>
                            <span class="ms-2 selected-rating">5점</span>
                        </div>
                    </div>
                </div>

                <!-- 리뷰 내용 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">리뷰 내용</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="title" class="form-label">제목</label>
                            <input type="text" class="form-control" id="title" name="title" 
                                   placeholder="리뷰 제목을 입력해주세요" required>
                        </div>
                        <div class="mb-3">
                            <label for="content" class="form-label">내용</label>
                            <textarea class="form-control" id="content" name="content" rows="5"
                                    placeholder="상품에 대한 솔직한 리뷰를 작성해주세요" required></textarea>
                        </div>
                    </div>
                </div>

                <!-- 사진 첨부 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">사진 첨부</h5>
                    </div>
                    <div class="card-body">
                        <div class="image-upload-container">
                            <div class="image-preview-container mb-3">
                                <div class="row" id="imagePreview"></div>
                            </div>
                            <div class="custom-file">
                                <input type="file" class="form-control" id="images" name="images" 
                                       accept="image/*" multiple>
                                <small class="text-muted d-block mt-2">
                                    * 최대 5장까지 첨부 가능합니다. (jpg, png 파일)
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-center gap-2">
                    <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                        취소
                    </button>
                    <button type="submit" class="btn btn-primary">
                        리뷰 등록
                    </button>
                </div>
            </form>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            $(document).ready(function() {
                // 별점 선택
                $('.rating-stars input').change(function() {
                    const rating = $(this).val();
                    $('.selected-rating').text(rating + '점');
                });

                // 이미지 미리보기
                $('#images').change(function() {
                    const files = Array.from(this.files);
                    const maxFiles = 5;

                    if (files.length > maxFiles) {
                        alert('최대 ' + maxFiles + '장까지 첨부할 수 있습니다.');
                        this.value = '';
                        return;
                    }

                    $('#imagePreview').empty();

                    files.forEach(file => {
                        if (!file.type.startsWith('image/')) {
                            alert('이미지 파일만 첨부할 수 있습니다.');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const col = $('<div class="col-4 col-md-3 mb-3">');
                            const card = $('<div class="card h-100">');
                            const img = $('<img class="card-img-top" style="height: 200px; object-fit: cover;">');
                            img.attr('src', e.target.result);
                            card.append(img);
                            col.append(card);
                            $('#imagePreview').append(col);
                        }
                        reader.readAsDataURL(file);
                    });
                });

                // 폼 제출
                $('#reviewForm').submit(function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    
                    $.ajax({
                        url: $(this).attr('action'),
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            alert('리뷰가 등록되었습니다.');
                            location.href = '/mypage/reviews';
                        },
                        error: function(xhr, status, error) {
                            alert('리뷰 등록에 실패했습니다. 다시 시도해주세요.');
                        }
                    });
                });
            });
        </script>
    </th:block>
</body>
</html> 