<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop-layout}">
<head>
    <title>장바구니 - PeakMeShop</title>
    <th:block layout:fragment="css">
        <style>
            .cart-container {
                min-height: 60vh;
            }
            .cart-item {
                border-radius: 1rem;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
                margin-bottom: 1.5rem;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            .cart-item:hover {
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                transform: translateY(-5px);
            }
            .cart-item-img {
                width: 100px;
                height: 100px;
                object-fit: cover;
                border-radius: 0.5rem;
            }
            .cart-summary {
                border-radius: 1rem;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
                padding: 1.5rem;
                position: sticky;
                top: 100px;
            }
            .quantity-control {
                display: flex;
                align-items: center;
                justify-content: center;
                max-width: 120px;
            }
            .quantity-control .btn {
                width: 30px;
                height: 30px;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
            }
            .quantity-control input {
                width: 40px;
                text-align: center;
                border: none;
                background: transparent;
            }
            .empty-cart {
                text-align: center;
                padding: 3rem 0;
            }
            .empty-cart i {
                font-size: 5rem;
                color: var(--gray-300);
                margin-bottom: 1.5rem;
            }
        </style>
        <!-- CSS 파일 -->
        <link rel="stylesheet" href="/css/bootstrap.min.css">
        <link rel="stylesheet" href="/css/font-awesome.min.css">
        <link rel="stylesheet" href="/css/style.css">
        <link rel="stylesheet" th:href="@{/css/components.css}">
    </th:block>
</head>
<body>
<!-- 헤더 포함 -->
<div th:replace="fragments/header :: header"></div>

<!-- 페이지 타이틀 -->
<div class="page-title-area">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="page-title-content">
                    <h2>장바구니</h2>
                    <ul class="breadcrumb">
                        <li><a href="/">홈</a></li>
                        <li><a href="/shop/product-list">쇼핑</a></li>
                        <li class="active">장바구니</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<main layout:fragment="content">
    <div class="container py-5">
        <h2 class="mb-4">장바구니</h2>

        <!-- 장바구니가 비어있을 경우 -->
        <div th:if="${#lists.isEmpty(cart.items)}" class="text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
            <h3>장바구니가 비어있습니다</h3>
            <p class="text-muted">원하는 상품을 장바구니에 담아보세요!</p>
            <a th:href="@{/products}" class="btn btn-primary mt-3">쇼핑 계속하기</a>
        </div>

        <!-- 장바구니 내역 -->
        <div th:if="${!#lists.isEmpty(cart.items)}" class="row">
            <div class="col-lg-8">
                <!-- 전체 선택 -->
                <div class="d-flex align-items-center mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll" checked>
                        <label class="form-check-label" for="selectAll">전체 선택</label>
                    </div>
                    <button class="btn btn-outline-danger btn-sm ms-3" id="deleteSelected">
                        선택 삭제
                    </button>
                </div>

                <!-- 장바구니 상품 목록 -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="cart-item" th:each="item : ${cart.items}">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input class="form-check-input item-checkbox" type="checkbox" 
                                               th:value="${item.id}" checked>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <img th:src="${item.product.mainImage}" alt="상품 이미지" 
                                         class="img-thumbnail" style="width: 100px;">
                                </div>
                                <div class="col">
                                    <h5 class="mb-1" th:text="${item.product.name}">상품명</h5>
                                    <p class="text-muted small mb-1" th:text="${item.product.brand?.name}">브랜드</p>
                                    <p class="text-muted small mb-0" th:if="${item.options != null}"
                                       th:text="${item.options}">옵션</p>
                                </div>
                                <div class="col-auto">
                                    <div class="input-group input-group-sm" style="width: 120px;">
                                        <button class="btn btn-outline-secondary decrease-quantity" type="button"
                                                th:data-item-id="${item.id}">-</button>
                                        <input type="number" class="form-control text-center quantity-input" 
                                               th:value="${item.quantity}" min="1" max="99"
                                               th:data-item-id="${item.id}">
                                        <button class="btn btn-outline-secondary increase-quantity" type="button"
                                                th:data-item-id="${item.id}">+</button>
                                    </div>
                                </div>
                                <div class="col-auto text-end">
                                    <p class="mb-0 fw-bold" th:text="${#numbers.formatInteger(item.totalPrice, 0, 'COMMA') + '원'}">
                                        가격
                                    </p>
                                    <p class="text-muted small mb-0" th:if="${item.product.originalPrice > item.product.price}">
                                        <del th:text="${#numbers.formatInteger(item.product.originalPrice * item.quantity, 0, 'COMMA') + '원'}">
                                            정가
                                        </del>
                                    </p>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-outline-danger btn-sm remove-item"
                                            th:data-item-id="${item.id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <hr th:if="${!itemStat.last}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- 주문 요약 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">주문 요약</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>상품 금액</span>
                            <span th:text="${#numbers.formatInteger(cart.totalPrice, 0, 'COMMA') + '원'}">0원</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>할인 금액</span>
                            <span class="text-danger" 
                                  th:text="${'-' + #numbers.formatInteger(cart.totalDiscountAmount, 0, 'COMMA') + '원'}">0원</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>배송비</span>
                            <span th:text="${#numbers.formatInteger(cart.shippingFee, 0, 'COMMA') + '원'}">0원</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold">결제 예정 금액</span>
                            <span class="fw-bold" 
                                  th:text="${#numbers.formatInteger(cart.finalAmount, 0, 'COMMA') + '원'}">0원</span>
                        </div>
                        <div class="text-end text-muted small">
                            <span>적립 예정 포인트: </span>
                            <span th:text="${#numbers.formatInteger(cart.expectedPoints, 0, 'COMMA') + 'P'}">0P</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-primary w-100" id="proceedToCheckout">
                            주문하기
                        </button>
                    </div>
                </div>

                <!-- 추천 상품 -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">추천 상품</h5>
                    </div>
                    <div class="card-body">
                        <div class="row row-cols-2 g-2">
                            <div class="col" th:each="product : ${recommendedProducts}">
                                <div class="card h-100">
                                    <img th:src="${product.mainImage}" class="card-img-top" alt="상품 이미지">
                                    <div class="card-body p-2">
                                        <p class="card-text small text-muted mb-1" th:text="${product.brand?.name}">브랜드</p>
                                        <h6 class="card-title small mb-1" th:text="${product.name}">상품명</h6>
                                        <p class="card-text small mb-0">
                                            <span class="text-danger" th:if="${product.discountRate > 0}"
                                                  th:text="${product.discountRate + '%'}">할인율</span>
                                            <strong th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">가격</strong>
                                        </p>
                                    </div>
                                    <a th:href="@{'/products/' + ${product.id}}" class="stretched-link"></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 푸터 포함 -->
<div th:replace="fragments/footer :: footer"></div>

<!-- 토스트 메시지 컨테이너 -->
<div class="toast-container"></div>

<th:block layout:fragment="scripts">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/cart.js"></script>
    <script th:inline="javascript">
        $(document).ready(function() {
            // 전체 선택/해제
            $('#selectAll').change(function() {
                $('.item-checkbox').prop('checked', $(this).prop('checked'));
                updateOrderSummary();
            });

            // 개별 체크박스 변경 시
            $('.item-checkbox').change(function() {
                updateSelectAll();
                updateOrderSummary();
            });

            // 수량 감소
            $('.decrease-quantity').click(function() {
                const input = $(this).siblings('.quantity-input');
                const currentValue = parseInt(input.val());
                if (currentValue > 1) {
                    input.val(currentValue - 1).trigger('change');
                }
            });

            // 수량 증가
            $('.increase-quantity').click(function() {
                const input = $(this).siblings('.quantity-input');
                const currentValue = parseInt(input.val());
                if (currentValue < 99) {
                    input.val(currentValue + 1).trigger('change');
                }
            });

            // 수량 직접 입력
            $('.quantity-input').change(function() {
                const itemId = $(this).data('item-id');
                const quantity = parseInt($(this).val());
                
                if (quantity < 1) {
                    $(this).val(1);
                } else if (quantity > 99) {
                    $(this).val(99);
                }

                updateCartItem(itemId, quantity);
            });

            // 개별 상품 삭제
            $('.remove-item').click(function() {
                const itemId = $(this).data('item-id');
                removeCartItem(itemId);
            });

            // 선택 상품 삭제
            $('#deleteSelected').click(function() {
                const selectedItems = $('.item-checkbox:checked').map(function() {
                    return $(this).val();
                }).get();

                if (selectedItems.length > 0) {
                    if (confirm('선택한 상품을 삭제하시겠습니까?')) {
                        removeCartItems(selectedItems);
                    }
                }
            });

            // 주문하기
            $('#proceedToCheckout').click(function() {
                const selectedItems = $('.item-checkbox:checked').map(function() {
                    return $(this).val();
                }).get();

                if (selectedItems.length === 0) {
                    alert('주문할 상품을 선택해주세요.');
                    return;
                }

                location.href = '/checkout?items=' + selectedItems.join(',');
            });

            function updateSelectAll() {
                const total = $('.item-checkbox').length;
                const checked = $('.item-checkbox:checked').length;
                $('#selectAll').prop('checked', total === checked);
            }

            function updateOrderSummary() {
                // AJAX로 선택된 상품들의 주문 요약 정보 업데이트
            }

            function updateCartItem(itemId, quantity) {
                // AJAX로 장바구니 상품 수량 업데이트
            }

            function removeCartItem(itemId) {
                // AJAX로 장바구니 상품 삭제
            }

            function removeCartItems(itemIds) {
                // AJAX로 선택된 장바구니 상품들 삭제
            }
        });
    </script>
</th:block>
</body>
</html>

