<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop-layout}">
<head>
    <title>상품 비교 - PeakMeShop</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container py-5">
            <h2 class="mb-4">상품 비교</h2>

            <!-- 상품 선택 -->
            <div class="card mb-4" th:if="${products.size() < 4}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchProduct"
                                       placeholder="비교할 상품을 검색하세요">
                                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-0">
                                * 최대 4개까지 상품을 비교할 수 있습니다.
                            </p>
                        </div>
                    </div>
                    <div id="searchResults" class="mt-3" style="display: none;">
                        <div class="list-group">
                            <!-- 검색 결과는 JavaScript로 동적 추가 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 비교 테이블 -->
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 15%">비교 항목</th>
                            <th th:each="product, stat : ${products}" style="width: 21.25%">
                                <div class="position-relative">
                                    <button type="button" class="btn-close position-absolute top-0 end-0"
                                            th:onclick="'removeProduct(' + ${stat.index} + ')'"></button>
                                    <img th:src="${product.mainImage}" class="img-fluid mb-2" alt="상품 이미지">
                                    <p class="small text-muted mb-1" th:text="${product.brand?.name}">브랜드</p>
                                    <h6 class="mb-2" th:text="${product.name}">상품명</h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="text-danger" th:if="${product.discountRate > 0}"
                                                  th:text="${product.discountRate + '%'}">할인율</span>
                                            <span class="fw-bold" 
                                                  th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">
                                                가격
                                            </span>
                                        </div>
                                        <a th:href="@{'/products/' + ${product.id}}" 
                                           class="btn btn-sm btn-outline-primary">상세보기</a>
                                    </div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 기본 정보 -->
                        <tr>
                            <th>카테고리</th>
                            <td th:each="product : ${products}" th:text="${product.category?.name}">카테고리</td>
                        </tr>
                        <tr>
                            <th>평점</th>
                            <td th:each="product : ${products}">
                                <div class="rating-stars">
                                    <i class="bi bi-star-fill text-warning"
                                       th:each="i : ${#numbers.sequence(1, 5)}"
                                       th:classappend="${i <= product.averageRating ? 'text-warning' : 'text-muted'}"></i>
                                    <span class="ms-1" 
                                          th:text="${#numbers.formatDecimal(product.averageRating, 1, 1)}">4.5</span>
                                    <span class="text-muted" 
                                          th:text="${'(' + product.reviewCount + ')'}">리뷰수</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>배송비</th>
                            <td th:each="product : ${products}">
                                <span th:if="${product.shippingFee == 0}">무료배송</span>
                                <span th:unless="${product.shippingFee == 0}"
                                      th:text="${#numbers.formatInteger(product.shippingFee, 0, 'COMMA') + '원'}">
                                    배송비
                                </span>
                            </td>
                        </tr>

                        <!-- 상품 옵션 -->
                        <tr>
                            <th>옵션</th>
                            <td th:each="product : ${products}">
                                <ul class="list-unstyled mb-0">
                                    <li th:each="option : ${product.options}" 
                                        th:text="${option.name + ': ' + option.values}">
                                        옵션명: 옵션값
                                    </li>
                                </ul>
                            </td>
                        </tr>

                        <!-- 상품 상세 정보 -->
                        <tr th:each="spec : ${specifications}">
                            <th th:text="${spec.name}">상세 정보</th>
                            <td th:each="product : ${products}" 
                                th:text="${product.specifications[spec.name]}">상세 정보 값</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            $(document).ready(function() {
                let searchTimeout;

                // 상품 검색
                $('#searchProduct').on('input', function() {
                    clearTimeout(searchTimeout);
                    const query = $(this).val().trim();
                    
                    if (query.length < 2) {
                        $('#searchResults').hide();
                        return;
                    }

                    searchTimeout = setTimeout(function() {
                        $.get('/api/products/search', { keyword: query })
                            .done(function(response) {
                                const results = response.content;
                                const $resultList = $('#searchResults .list-group').empty();

                                if (results.length === 0) {
                                    $resultList.append(
                                        '<div class="list-group-item text-center text-muted">' +
                                        '검색 결과가 없습니다.' +
                                        '</div>'
                                    );
                                } else {
                                    results.forEach(function(product) {
                                        $resultList.append(
                                            '<a href="#" class="list-group-item list-group-item-action" ' +
                                            'data-product-id="' + product.id + '">' +
                                            '<div class="d-flex align-items-center">' +
                                            '<img src="' + product.mainImage + '" ' +
                                            'style="width: 50px; height: 50px; object-fit: cover;" ' +
                                            'class="me-3" alt="상품 이미지">' +
                                            '<div>' +
                                            '<h6 class="mb-1">' + product.name + '</h6>' +
                                            '<p class="small text-muted mb-0">' + product.brand.name + '</p>' +
                                            '</div>' +
                                            '</div>' +
                                            '</a>'
                                        );
                                    });
                                }

                                $('#searchResults').show();
                            });
                    }, 300);
                });

                // 검색 결과 클릭
                $(document).on('click', '#searchResults .list-group-item', function(e) {
                    e.preventDefault();
                    const productId = $(this).data('product-id');
                    addProductToCompare(productId);
                    $('#searchResults').hide();
                    $('#searchProduct').val('');
                });

                // 상품 추가
                function addProductToCompare(productId) {
                    const currentUrl = new URL(window.location.href);
                    const products = currentUrl.searchParams.getAll('products');
                    
                    if (!products.includes(productId.toString())) {
                        products.push(productId);
                        currentUrl.searchParams.delete('products');
                        products.forEach(id => currentUrl.searchParams.append('products', id));
                        window.location.href = currentUrl.toString();
                    }
                }

                // 상품 제거
                window.removeProduct = function(index) {
                    const currentUrl = new URL(window.location.href);
                    const products = currentUrl.searchParams.getAll('products');
                    products.splice(index, 1);
                    currentUrl.searchParams.delete('products');
                    products.forEach(id => currentUrl.searchParams.append('products', id));
                    window.location.href = currentUrl.toString();
                };
            });
        </script>
    </th:block>
</body>
</html> 