<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop-layout}">
<head>
    <title>PeakMeShop - 트렌디한 쇼핑의 시작</title>
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
</head>
<body>
<main layout:fragment="content">
    <!-- 히어로 섹션 -->
    <section class="hero-section position-relative">
        <div class="swiper hero-slider">
            <div class="swiper-wrapper">
                <div class="swiper-slide" th:each="banner : ${mainBanners}">
                    <div class="hero-slide" th:style="'background-image: url(' + ${banner.imageUrl} + ')'">
                        <div class="container h-100">
                            <div class="row h-100 align-items-center">
                                <div class="col-lg-6">
                                    <div class="hero-content" data-aos="fade-right">
                                        <h1 class="display-4 fw-bold" th:text="${banner.title}">트렌디한 스타일을 발견하세요</h1>
                                        <p class="lead mb-4" th:text="${banner.description}">최신 트렌드와 스타일리시한 제품들을 만나보세요.</p>
                                        <div class="d-flex gap-3">
                                            <a th:href="${banner.primaryLink}" class="btn btn-custom-primary">
                                                자세히 보기
                                            </a>
                                            <a th:href="${banner.secondaryLink}" class="btn btn-custom-outline">
                                                컬렉션 보기
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="swiper-pagination"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
    </section>

    <!-- 카테고리 섹션 -->
    <section class="categories-section py-5">
        <div class="container">
            <h2 class="section-title">인기 카테고리</h2>
            <div class="responsive-grid">
                <div th:each="category : ${categories}" class="category-card" data-aos="fade-up">
                    <img th:src="${category.imageUrl}" class="category-image" th:alt="${category.name}">
                    <div class="category-overlay">
                        <h3 class="h5 mb-2" th:text="${category.name}">카테고리명</h3>
                        <p class="mb-3" th:text="${category.description}">카테고리 설명</p>
                        <a th:href="@{'/category/' + ${category.slug}}" class="btn btn-custom-primary btn-sm">둘러보기</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 신상품 섹션 -->
    <section class="new-arrivals-section py-5 bg-light">
        <div class="container">
            <h2 class="section-title">신상품</h2>
            <div class="responsive-grid">
                <div th:each="product : ${newProducts}" class="product-card" data-aos="fade-up">
                    <div class="product-image-wrapper">
                        <span class="product-badge badge-new">NEW</span>
                        <img th:src="${product.mainImage}" class="product-image" th:alt="${product.name}"
                             loading="lazy">
                        <div class="product-actions">
                            <button class="action-button" th:onclick="'quickView(' + ${product.id} + ')'">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-button" th:onclick="'addToWishlist(' + ${product.id} + ')'">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="action-button" th:onclick="'addToCart(' + ${product.id} + ')'">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="h6 mb-2" th:text="${product.name}">상품명</h3>
                        <div class="rating-stars mb-2">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                            <span class="ms-1 text-muted" th:text="${product.averageRating}">4.5</span>
                        </div>
                        <div class="price-display">
                            <span th:if="${product.salePrice != null}" class="original-price" 
                                  th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT') + '원'}">
                            </span>
                            <span class="sale-price" 
                                  th:text="${#numbers.formatDecimal(product.salePrice != null ? product.salePrice : product.price, 0, 'COMMA', 0, 'POINT') + '원'}">
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <a href="/new-arrivals" class="btn btn-custom-outline">더 많은 신상품 보기</a>
            </div>
        </div>
    </section>

    <!-- 베스트셀러 섹션 -->
    <section class="best-sellers-section py-5">
        <div class="container">
            <h2 class="section-title">베스트셀러</h2>
            <div class="responsive-grid">
                <div th:each="product : ${bestProducts}" class="product-card" data-aos="fade-up">
                    <div class="product-image-wrapper">
                        <span class="product-badge badge-hot">HOT</span>
                        <img th:src="${product.mainImage}" class="product-image" th:alt="${product.name}"
                             loading="lazy">
                        <div class="product-actions">
                            <button class="action-button" th:onclick="'quickView(' + ${product.id} + ')'">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-button" th:onclick="'addToWishlist(' + ${product.id} + ')'">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="action-button" th:onclick="'addToCart(' + ${product.id} + ')'">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="h6 mb-2" th:text="${product.name}">상품명</h3>
                        <div class="rating-stars mb-2">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                            <span class="ms-1 text-muted" th:text="${product.averageRating}">4.5</span>
                        </div>
                        <div class="price-display">
                            <span th:if="${product.salePrice != null}" class="original-price" 
                                  th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT') + '원'}">
                            </span>
                            <span class="sale-price" 
                                  th:text="${#numbers.formatDecimal(product.salePrice != null ? product.salePrice : product.price, 0, 'COMMA', 0, 'POINT') + '원'}">
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <a href="/best-sellers" class="btn btn-custom-outline">더 많은 베스트셀러 보기</a>
            </div>
        </div>
    </section>

    <!-- 특가 세일 섹션 -->
    <section class="sale-section py-5 bg-light">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6" data-aos="fade-right">
                    <div class="sale-content p-4">
                        <h2 class="mb-4">시즌 특가 세일</h2>
                        <p class="lead mb-4">최대 50% 할인된 가격으로 프리미엄 제품을 만나보세요.</p>
                        <div class="countdown-timer mb-4">
                            <div class="d-flex gap-3">
                                <div class="timer-item">
                                    <span class="days">00</span>
                                    <span class="timer-label">일</span>
                                </div>
                                <div class="timer-item">
                                    <span class="hours">00</span>
                                    <span class="timer-label">시</span>
                                </div>
                                <div class="timer-item">
                                    <span class="minutes">00</span>
                                    <span class="timer-label">분</span>
                                </div>
                                <div class="timer-item">
                                    <span class="seconds">00</span>
                                    <span class="timer-label">초</span>
                                </div>
                            </div>
                        </div>
                        <a href="/sale" class="btn btn-custom-primary">할인 상품 보기</a>
                    </div>
                </div>
                <div class="col-lg-6" data-aos="fade-left">
                    <div class="row">
                        <div th:each="product : ${saleProducts}" class="col-6 mb-4">
                            <div class="product-card">
                                <div class="product-image-wrapper">
                                    <span class="product-badge badge-sale" 
                                          th:text="${'-' + #numbers.formatInteger((product.price - product.salePrice) * 100 / product.price, 0) + '%'}">
                                    </span>
                                    <img th:src="${product.mainImage}" class="product-image" th:alt="${product.name}"
                                         loading="lazy">
                                </div>
                                <div class="p-3">
                                    <h3 class="h6 mb-2" th:text="${product.name}">상품명</h3>
                                    <div class="price-display">
                                        <span class="original-price" 
                                              th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT') + '원'}">
                                        </span>
                                        <span class="sale-price" 
                                              th:text="${#numbers.formatDecimal(product.salePrice, 0, 'COMMA', 0, 'POINT') + '원'}">
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 브랜드 섹션 -->
    <section class="brands-section py-5">
        <div class="container">
            <h2 class="section-title">인기 브랜드</h2>
            <div class="swiper brands-slider">
                <div class="swiper-wrapper">
                    <div th:each="brand : ${brands}" class="swiper-slide">
                        <div class="brand-card text-center" data-aos="fade-up">
                            <img th:src="${brand.logoUrl}" class="brand-logo mb-3" th:alt="${brand.name}">
                            <h3 class="h6" th:text="${brand.name}">브랜드명</h3>
                            <p class="small text-muted" th:text="${brand.description}">브랜드 설명</p>
                            <a th:href="@{'/brand/' + ${brand.slug}}" class="btn btn-custom-outline btn-sm">브랜드 보기</a>
                        </div>
                    </div>
                </div>
                <div class="swiper-pagination"></div>
            </div>
        </div>
    </section>
</main>

<!-- 퀵뷰 모달 -->
<div class="modal fade" id="quickViewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body p-0">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
                <div class="row g-0">
                    <div class="col-md-6">
                        <div class="product-image-wrapper">
                            <img src="" class="product-image" id="quickViewImage" alt="상품 이미지">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-4">
                            <h3 id="quickViewTitle" class="mb-3">상품명</h3>
                            <div class="rating-stars mb-3">
                                <div id="quickViewRating"></div>
                            </div>
                            <div class="price-display mb-3">
                                <span id="quickViewOriginalPrice" class="original-price"></span>
                                <span id="quickViewPrice" class="sale-price"></span>
                            </div>
                            <p id="quickViewDescription" class="mb-4">상품 설명</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-custom-primary" onclick="addToCart(productId)">
                                    장바구니에 담기
                                </button>
                                <a href="" id="quickViewLink" class="btn btn-custom-outline">
                                    상세 정보 보기
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 토스트 메시지 컨테이너 -->
<div class="toast-container"></div>

<th:block layout:fragment="scripts">
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="https://unpkg.com/aos/dist/aos.js"></script>
    <script th:inline="javascript">
        // Swiper 초기화
        new Swiper('.hero-slider', {
            loop: true,
            autoplay: {
                delay: 5000,
                disableOnInteraction: false,
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
        });

        new Swiper('.brands-slider', {
            slidesPerView: 2,
            spaceBetween: 20,
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
            breakpoints: {
                640: {
                    slidesPerView: 3,
                },
                768: {
                    slidesPerView: 4,
                },
                1024: {
                    slidesPerView: 5,
                },
            },
        });

        // AOS 초기화
        AOS.init({
            duration: 1000,
            once: true,
        });

        // 카운트다운 타이머
        function updateTimer() {
            const endDate = new Date(/*[[${saleEndDate}]]*/).getTime();
            const now = new Date().getTime();
            const distance = endDate - now;

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            document.querySelector('.days').textContent = String(days).padStart(2, '0');
            document.querySelector('.hours').textContent = String(hours).padStart(2, '0');
            document.querySelector('.minutes').textContent = String(minutes).padStart(2, '0');
            document.querySelector('.seconds').textContent = String(seconds).padStart(2, '0');
        }

        setInterval(updateTimer, 1000);
        updateTimer();

        // 퀵뷰 기능
        async function quickView(productId) {
            try {
                const response = await fetch(`/api/products/${productId}/quick-view`);
                const product = await response.json();
                
                document.getElementById('quickViewImage').src = product.mainImage;
                document.getElementById('quickViewTitle').textContent = product.name;
                document.getElementById('quickViewDescription').textContent = product.description;
                document.getElementById('quickViewLink').href = `/products/${product.id}`;
                
                if (product.salePrice) {
                    document.getElementById('quickViewOriginalPrice').textContent = 
                        new Intl.NumberFormat('ko-KR').format(product.price) + '원';
                    document.getElementById('quickViewPrice').textContent = 
                        new Intl.NumberFormat('ko-KR').format(product.salePrice) + '원';
                } else {
                    document.getElementById('quickViewOriginalPrice').textContent = '';
                    document.getElementById('quickViewPrice').textContent = 
                        new Intl.NumberFormat('ko-KR').format(product.price) + '원';
                }

                const rating = document.getElementById('quickViewRating');
                rating.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const star = document.createElement('i');
                    star.className = i < Math.floor(product.averageRating) ? 'fas fa-star' :
                        i === Math.floor(product.averageRating) && product.averageRating % 1 >= 0.5 ?
                        'fas fa-star-half-alt' : 'far fa-star';
                    rating.appendChild(star);
                }
                
                new bootstrap.Modal(document.getElementById('quickViewModal')).show();
            } catch (error) {
                showToast('상품 정보를 불러오는데 실패했습니다.', 'error');
            }
        }

        // 장바구니 추가
        async function addToCart(productId) {
            try {
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productId, quantity: 1 })
                });

                if (response.ok) {
                    showToast('장바구니에 상품이 추가되었습니다.', 'success');
                    updateCartCount();
                } else {
                    throw new Error('장바구니 추가 실패');
                }
            } catch (error) {
                showToast('장바구니 추가에 실패했습니다.', 'error');
            }
        }

        // 위시리스트 추가
        async function addToWishlist(productId) {
            try {
                const response = await fetch('/api/wishlist/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productId })
                });

                if (response.ok) {
                    showToast('위시리스트에 추가되었습니다.', 'success');
                } else {
                    throw new Error('위시리스트 추가 실패');
                }
            } catch (error) {
                showToast('위시리스트 추가에 실패했습니다.', 'error');
            }
        }

        // 토스트 메시지 표시
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.querySelector('.toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // 장바구니 카운트 업데이트
        async function updateCartCount() {
            try {
                const response = await fetch('/api/cart/count');
                const count = await response.json();
                
                const cartCount = document.querySelector('.cart-count');
                if (cartCount) {
                    cartCount.textContent = count;
                }
            } catch (error) {
                console.error('장바구니 수량 업데이트 실패:', error);
            }
        }
    </script>
</th:block>
</body>
</html>