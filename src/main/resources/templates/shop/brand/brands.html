<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop-layout}">
<head>
    <title>브랜드 - PeakMeShop</title>
    <link rel="stylesheet" th:href="@{/css/components.css}">
</head>
<body>
<main layout:fragment="content">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">브랜드</h1>
            <div class="d-flex gap-2">
                <div class="input-group">
                    <input type="text" 
                           class="form-control" 
                           id="brandSearch" 
                           placeholder="브랜드 검색"
                           onkeyup="searchBrands(this.value)">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <select class="form-select" onchange="sortBrands(this.value)">
                    <option value="name">이름순</option>
                    <option value="products">상품 많은순</option>
                    <option value="popular">인기순</option>
                </select>
            </div>
        </div>

        <!-- 브랜드 카테고리 -->
        <div class="mb-4">
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-custom-outline active" 
                        onclick="filterByInitial('all')">전체</button>
                <th:block th:each="initial : ${#strings.arraySplit('ㄱㄴㄷㄹㅁㅂㅅㅇㅈㅊㅋㅌㅍㅎABCDEFGHIJKLMNOPQRSTUVWXYZ', '')}">
                    <button class="btn btn-custom-outline"
                            th:onclick="'filterByInitial(\'' + ${initial} + '\')'">[[${initial}]]</button>
                </th:block>
            </div>
        </div>

        <!-- 브랜드 목록 -->
        <div class="row g-4" id="brandList">
            <div th:each="brand : ${brands}" class="col-6 col-md-4 col-lg-3">
                <a th:href="@{'/brands/' + ${brand.id}}" class="text-decoration-none">
                    <div class="card h-100 brand-card">
                        <div class="card-body text-center">
                            <img th:if="${brand.logo}" 
                                 th:src="${brand.logo}" 
                                 class="mb-3" 
                                 style="max-height: 50px;"
                                 th:alt="${brand.name} + ' 로고'">
                            <h3 class="h5 mb-2" th:text="${brand.name}">브랜드명</h3>
                            <p class="text-muted mb-2" th:text="${brand.description}">브랜드 설명</p>
                            <div class="d-flex justify-content-center gap-3 text-muted small">
                                <span>
                                    <i class="fas fa-box me-1"></i>
                                    <span th:text="${brand.productCount}">0</span>개 상품
                                </span>
                                <span>
                                    <i class="fas fa-heart me-1"></i>
                                    <span th:text="${brand.followerCount}">0</span>명
                                </span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- 브랜드 없을 때 -->
        <div th:if="${#lists.isEmpty(brands)}" class="text-center py-5">
            <i class="fas fa-store text-muted mb-3" style="font-size: 3rem;"></i>
            <h3>브랜드가 없습니다</h3>
            <p class="text-muted">검색어를 변경하여 다시 시도해보세요.</p>
        </div>

        <!-- 더보기 버튼 -->
        <div th:if="${not #lists.isEmpty(brands)}" class="d-flex justify-content-center mt-4">
            <button class="btn btn-custom-outline" onclick="loadMoreBrands()">
                더 보기
            </button>
        </div>
    </div>
</main>

<!-- 토스트 메시지 컨테이너 -->
<div class="toast-container"></div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        let currentPage = 0;
        let loading = false;
        let hasMore = true;
        let currentSort = 'name';
        let currentInitial = 'all';
        let currentSearch = '';

        // 브랜드 검색
        function searchBrands(query) {
            currentSearch = query;
            currentPage = 0;
            loadBrands();
        }

        // 브랜드 정렬
        function sortBrands(value) {
            currentSort = value;
            currentPage = 0;
            loadBrands();
        }

        // 초성 필터
        function filterByInitial(initial) {
            document.querySelectorAll('.btn-custom-outline').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="filterByInitial('${initial}')"]`).classList.add('active');
            
            currentInitial = initial;
            currentPage = 0;
            loadBrands();
        }

        // 브랜드 로드
        async function loadBrands() {
            try {
                loading = true;
                updateLoadingState();

                const params = new URLSearchParams({
                    page: currentPage,
                    sort: currentSort,
                    initial: currentInitial,
                    search: currentSearch
                });

                const response = await fetch(`/api/brands?${params}`);
                if (!response.ok) throw new Error('브랜드 로딩 실패');

                const data = await response.json();
                if (currentPage === 0) {
                    document.getElementById('brandList').innerHTML = '';
                }
                
                data.items.forEach(item => appendBrandItem(item));
                hasMore = data.hasMore;
                currentPage = data.currentPage;

            } catch (error) {
                showToast('브랜드를 불러오는데 실패했습니다.', 'error');
            } finally {
                loading = false;
                updateLoadingState();
            }
        }

        // 브랜드 아이템 추가
        function appendBrandItem(brand) {
            const template = `
                <div class="col-6 col-md-4 col-lg-3">
                    <a href="/brands/${brand.id}" class="text-decoration-none">
                        <div class="card h-100 brand-card">
                            <div class="card-body text-center">
                                ${brand.logo ? `
                                    <img src="${brand.logo}" 
                                         class="mb-3" 
                                         style="max-height: 50px;"
                                         alt="${brand.name} 로고">
                                ` : ''}
                                <h3 class="h5 mb-2">${brand.name}</h3>
                                <p class="text-muted mb-2">${brand.description}</p>
                                <div class="d-flex justify-content-center gap-3 text-muted small">
                                    <span>
                                        <i class="fas fa-box me-1"></i>
                                        ${brand.productCount}개 상품
                                    </span>
                                    <span>
                                        <i class="fas fa-heart me-1"></i>
                                        ${brand.followerCount}명
                                    </span>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            `;
            document.getElementById('brandList').insertAdjacentHTML('beforeend', template);
        }

        // 더보기
        function loadMoreBrands() {
            if (loading || !hasMore) return;
            currentPage++;
            loadBrands();
        }

        // 로딩 상태 업데이트
        function updateLoadingState() {
            const loadMoreBtn = document.querySelector('.btn-custom-outline[onclick="loadMoreBrands()"]');
            if (loadMoreBtn) {
                loadMoreBtn.disabled = loading;
                loadMoreBtn.innerHTML = loading ? 
                    '<span class="spinner-border spinner-border-sm me-2"></span>로딩 중...' : 
                    '더 보기';
            }
        }

        // 토스트 메시지 표시
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.querySelector('.toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</th:block>
</body>
</html> 