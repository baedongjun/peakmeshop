<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop-layout}">
<head>
    <title th:text="${brand.name + ' - PeakMeShop'}">브랜드 - PeakMeShop</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- 브랜드 헤더 -->
        <div class="brand-header py-5" th:style="'background-image: url(' + ${brand.bannerImage} + ')'">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <img th:src="${brand.logoImage}" alt="브랜드 로고" class="img-fluid rounded-circle mb-3"
                             style="width: 150px; height: 150px; object-fit: cover;">
                    </div>
                    <div class="col-md-9">
                        <h1 class="display-4 mb-2" th:text="${brand.name}">브랜드명</h1>
                        <p class="lead mb-3" th:text="${brand.description}">브랜드 설명</p>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-primary me-2" id="followButton"
                                    th:text="${isFollowing ? '팔로잉' : '팔로우'}"
                                    th:data-brand-id="${brand.id}"
                                    th:data-following="${isFollowing}">
                                팔로우
                            </button>
                            <span class="text-muted">
                                팔로워 <strong th:text="${#numbers.formatInteger(brand.followerCount, 0, 'COMMA')}">0</strong>명
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container py-5">
            <!-- 브랜드 탭 메뉴 -->
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <a class="nav-link active" href="#products" data-bs-toggle="tab">상품</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#about" data-bs-toggle="tab">브랜드 소개</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#reviews" data-bs-toggle="tab">리뷰</a>
                </li>
            </ul>

            <!-- 탭 컨텐츠 -->
            <div class="tab-content">
                <!-- 상품 탭 -->
                <div class="tab-pane fade show active" id="products">
                    <!-- 상품 필터 -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-secondary active"
                                        data-category="all">전체</button>
                                <button type="button" class="btn btn-outline-secondary"
                                        th:each="category : ${categories}"
                                        th:text="${category.name}"
                                        th:data-category="${category.id}">
                                    카테고리
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="sortOption">
                                <option value="newest">최신순</option>
                                <option value="price_asc">가격 낮은순</option>
                                <option value="price_desc">가격 높은순</option>
                                <option value="popular">인기순</option>
                            </select>
                        </div>
                    </div>

                    <!-- 상품 목록 -->
                    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
                        <div class="col" th:each="product : ${products}">
                            <div class="card h-100">
                                <img th:src="${product.mainImage}" class="card-img-top" alt="상품 이미지">
                                <div class="card-body">
                                    <h5 class="card-title" th:text="${product.name}">상품명</h5>
                                    <p class="card-text">
                                        <span class="text-danger" th:if="${product.discountRate > 0}"
                                              th:text="${product.discountRate + '%'}">할인율</span>
                                        <strong th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">가격</strong>
                                        <del class="text-muted small" th:if="${product.originalPrice > product.price}"
                                             th:text="${#numbers.formatInteger(product.originalPrice, 0, 'COMMA') + '원'}">
                                            정가
                                        </del>
                                    </p>
                                    <div class="d-flex align-items-center">
                                        <div class="rating-stars small">
                                            <i class="bi bi-star-fill text-warning"></i>
                                            <span th:text="${#numbers.formatDecimal(product.averageRating, 1, 1)}">4.5</span>
                                        </div>
                                        <span class="text-muted small ms-2"
                                              th:text="${'(' + product.reviewCount + ')'}">리뷰수</span>
                                    </div>
                                </div>
                                <a th:href="@{'/products/' + ${product.id}}" class="stretched-link"></a>
                            </div>
                        </div>
                    </div>

                    <!-- 페이지네이션 -->
                    <nav th:if="${products.totalPages > 1}" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${!products.hasPrevious() ? 'disabled' : ''}">
                                <a class="page-link" th:href="@{${#httpServletRequest.requestURI}(
                                    page=${products.number - 1},
                                    sort=${param.sort},
                                    category=${param.category}
                                )}">이전</a>
                            </li>
                            <li class="page-item" th:each="pageNum : ${#numbers.sequence(0, products.totalPages - 1)}"
                                th:classappend="${pageNum == products.number ? 'active' : ''}">
                                <a class="page-link" th:href="@{${#httpServletRequest.requestURI}(
                                    page=${pageNum},
                                    sort=${param.sort},
                                    category=${param.category}
                                )}" th:text="${pageNum + 1}">1</a>
                            </li>
                            <li class="page-item" th:classappend="${!products.hasNext() ? 'disabled' : ''}">
                                <a class="page-link" th:href="@{${#httpServletRequest.requestURI}(
                                    page=${products.number + 1},
                                    sort=${param.sort},
                                    category=${param.category}
                                )}">다음</a>
                            </li>
                        </ul>
                    </nav>
                </div>

                <!-- 브랜드 소개 탭 -->
                <div class="tab-pane fade" id="about">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- 브랜드 스토리 -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">브랜드 스토리</h4>
                                    <div th:utext="${brand.story}">
                                        브랜드 스토리 내용
                                    </div>
                                </div>
                            </div>

                            <!-- 브랜드 연혁 -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">연혁</h4>
                                    <div class="timeline">
                                        <div class="timeline-item" th:each="history : ${brand.history}">
                                            <div class="timeline-date" th:text="${history.date}">2024</div>
                                            <div class="timeline-content" th:text="${history.content}">
                                                연혁 내용
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <!-- 브랜드 정보 -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">브랜드 정보</h4>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-4">설립연도</dt>
                                        <dd class="col-sm-8" th:text="${brand.establishedYear}">2020</dd>

                                        <dt class="col-sm-4">대표자</dt>
                                        <dd class="col-sm-8" th:text="${brand.ceo}">대표자명</dd>

                                        <dt class="col-sm-4">본사</dt>
                                        <dd class="col-sm-8" th:text="${brand.headquarters}">본사 위치</dd>

                                        <dt class="col-sm-4">웹사이트</dt>
                                        <dd class="col-sm-8">
                                            <a th:href="${brand.website}" target="_blank" 
                                               th:text="${brand.website}">웹사이트</a>
                                        </dd>
                                    </dl>
                                </div>
                            </div>

                            <!-- 브랜드 SNS -->
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">SNS</h4>
                                    <div class="d-flex gap-3">
                                        <a th:if="${brand.instagram}" th:href="${brand.instagram}" 
                                           class="btn btn-outline-primary" target="_blank">
                                            <i class="bi bi-instagram"></i>
                                        </a>
                                        <a th:if="${brand.facebook}" th:href="${brand.facebook}"
                                           class="btn btn-outline-primary" target="_blank">
                                            <i class="bi bi-facebook"></i>
                                        </a>
                                        <a th:if="${brand.twitter}" th:href="${brand.twitter}"
                                           class="btn btn-outline-primary" target="_blank">
                                            <i class="bi bi-twitter"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 리뷰 탭 -->
                <div class="tab-pane fade" id="reviews">
                    <!-- 리뷰 통계 -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3 text-center">
                                    <h3 class="mb-0" th:text="${#numbers.formatDecimal(brand.averageRating, 1, 1)}">4.5</h3>
                                    <div class="rating-stars my-2">
                                        <i class="bi bi-star-fill text-warning"
                                           th:each="i : ${#numbers.sequence(1, 5)}"
                                           th:classappend="${i <= brand.averageRating ? 'text-warning' : 'text-muted'}"></i>
                                    </div>
                                    <p class="mb-0" th:text="${brand.reviewCount + '개의 리뷰'}">100개의 리뷰</p>
                                </div>
                                <div class="col-md-6">
                                    <div class="rating-bars">
                                        <div class="d-flex align-items-center mb-1" th:each="stat : ${ratingStats}">
                                            <div class="col-2 text-end pe-2" th:text="${stat.rating + '점'}">5점</div>
                                            <div class="col">
                                                <div class="progress" style="height: 15px;">
                                                    <div class="progress-bar bg-warning" role="progressbar"
                                                         th:style="'width: ' + ${stat.percentage} + '%'"
                                                         th:aria-valuenow="${stat.percentage}"
                                                         aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="col-2 ps-2" th:text="${stat.count + '개'}">50개</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 text-center">
                                    <p class="mb-2">포토 리뷰</p>
                                    <h4 class="mb-0" th:text="${photoReviewCount + '개'}">30개</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 리뷰 목록 -->
                    <div class="review-list">
                        <div class="card mb-3" th:each="review : ${reviews}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <div class="rating-stars mb-2">
                                            <i class="bi bi-star-fill text-warning"
                                               th:each="i : ${#numbers.sequence(1, review.rating)}"></i>
                                            <i class="bi bi-star text-warning"
                                               th:each="i : ${#numbers.sequence(review.rating + 1, 5)}"></i>
                                        </div>
                                        <h5 class="card-title" th:text="${review.title}">리뷰 제목</h5>
                                        <p class="text-muted small mb-2">
                                            <span th:text="${review.author}">작성자</span> |
                                            <span th:text="${#temporals.format(review.createdAt, 'yyyy.MM.dd')}">2024.03.14</span>
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-sm btn-outline-secondary helpful-btn"
                                                th:data-review-id="${review.id}">
                                            <i class="bi bi-hand-thumbs-up"></i>
                                            도움돼요 <span th:text="${review.helpfulCount}">0</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- 구매 상품 -->
                                <div class="purchased-product mb-3">
                                    <a th:href="@{'/products/' + ${review.product.id}}" 
                                       class="text-decoration-none text-dark">
                                        <div class="d-flex align-items-center">
                                            <img th:src="${review.product.mainImage}" 
                                                 class="img-thumbnail me-3" 
                                                 style="width: 60px;" alt="상품 이미지">
                                            <div>
                                                <h6 class="mb-1" th:text="${review.product.name}">상품명</h6>
                                                <p class="text-muted small mb-0" th:if="${review.productOption != null}"
                                                   th:text="${review.productOption}">옵션</p>
                                            </div>
                                        </div>
                                    </a>
                                </div>

                                <!-- 리뷰 내용 -->
                                <p class="card-text" th:text="${review.content}">리뷰 내용</p>

                                <!-- 리뷰 이미지 -->
                                <div class="review-images mb-3" th:if="${not #lists.isEmpty(review.images)}">
                                    <div class="row g-2">
                                        <div class="col-4 col-md-3" th:each="image : ${review.images}">
                                            <a href="#" class="review-image" th:data-image="${image}">
                                                <img th:src="${image}" class="img-fluid rounded" alt="리뷰 이미지">
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 페이지네이션 -->
                    <nav th:if="${reviews.totalPages > 1}" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${!reviews.hasPrevious() ? 'disabled' : ''}">
                                <a class="page-link" href="#reviews" th:data-page="${reviews.number - 1}">이전</a>
                            </li>
                            <li class="page-item" th:each="pageNum : ${#numbers.sequence(0, reviews.totalPages - 1)}"
                                th:classappend="${pageNum == reviews.number ? 'active' : ''}">
                                <a class="page-link" href="#reviews" th:data-page="${pageNum}"
                                   th:text="${pageNum + 1}">1</a>
                            </li>
                            <li class="page-item" th:classappend="${!reviews.hasNext() ? 'disabled' : ''}">
                                <a class="page-link" href="#reviews" th:data-page="${reviews.number + 1}">다음</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- 이미지 모달 -->
        <div class="modal fade" id="imageModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body p-0">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-2"
                                data-bs-dismiss="modal"></button>
                        <img src="" class="img-fluid" alt="리뷰 이미지">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            $(document).ready(function() {
                // 팔로우 버튼 클릭
                $('#followButton').click(function() {
                    const brandId = $(this).data('brand-id');
                    const isFollowing = $(this).data('following');
                    const button = $(this);

                    $.ajax({
                        url: '/api/brands/' + brandId + '/follow',
                        type: isFollowing ? 'DELETE' : 'POST',
                        success: function(response) {
                            button.data('following', !isFollowing);
                            button.text(isFollowing ? '팔로우' : '팔로잉');
                            // 팔로워 수 업데이트
                            location.reload();
                        },
                        error: function() {
                            alert('처리에 실패했습니다. 다시 시도해주세요.');
                        }
                    });
                });

                // 카테고리 필터
                $('.btn-group button').click(function() {
                    $(this).addClass('active').siblings().removeClass('active');
                    updateProducts();
                });

                // 정렬 옵션
                $('#sortOption').change(function() {
                    updateProducts();
                });

                // 리뷰 탭 페이지네이션
                $('#reviews .pagination a').click(function(e) {
                    e.preventDefault();
                    const page = $(this).data('page');
                    loadReviews(page);
                });

                // 도움돼요 버튼
                $(document).on('click', '.helpful-btn', function() {
                    const reviewId = $(this).data('review-id');
                    const button = $(this);

                    $.post('/api/reviews/' + reviewId + '/helpful')
                        .done(function(response) {
                            const count = button.find('span');
                            count.text(parseInt(count.text()) + 1);
                            button.prop('disabled', true);
                        })
                        .fail(function() {
                            alert('처리에 실패했습니다. 다시 시도해주세요.');
                        });
                });

                // 이미지 클릭
                $(document).on('click', '.review-image', function(e) {
                    e.preventDefault();
                    const imageUrl = $(this).data('image');
                    $('#imageModal img').attr('src', imageUrl);
                    $('#imageModal').modal('show');
                });

                function updateProducts() {
                    const category = $('.btn-group button.active').data('category');
                    const sort = $('#sortOption').val();
                    
                    $.get('/api/brands/' + /*[[${brand.id}]]*/ '' + '/products', {
                        category: category,
                        sort: sort,
                        page: 0
                    }).done(function(response) {
                        // 상품 목록 업데이트
                        location.href = window.location.pathname + 
                            '?category=' + category + '&sort=' + sort;
                    });
                }

                function loadReviews(page) {
                    $.get('/api/brands/' + /*[[${brand.id}]]*/ '' + '/reviews', {
                        page: page
                    }).done(function(response) {
                        // 리뷰 목록 업데이트
                        const reviewList = $('.review-list');
                        reviewList.empty();
                        
                        response.content.forEach(function(review) {
                            // 리뷰 HTML 생성 및 추가
                        });

                        // 페이지네이션 업데이트
                    });
                }
            });
        </script>
    </th:block>
</body>
</html> 