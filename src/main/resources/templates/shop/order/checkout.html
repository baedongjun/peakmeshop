<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop-layout}">
<head>
    <title>주문/결제 - PeakMeShop</title>
    <th:block layout:fragment="css">
        <style>
            .checkout-container {
                min-height: 60vh;
            }
            .checkout-card {
                border-radius: 1rem;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
                overflow: hidden;
                border: none;
                margin-bottom: 1.5rem;
            }
            .checkout-card-header {
                background-color: var(--gray-100);
                padding: 1rem 1.5rem;
                border-bottom: 1px solid var(--gray-200);
            }
            .checkout-card-body {
                padding: 1.5rem;
            }
            .order-summary {
                border-radius: 1rem;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
                padding: 1.5rem;
                position: sticky;
                top: 100px;
            }
            .payment-method-item {
                border: 1px solid var(--gray-300);
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            .payment-method-item:hover {
                border-color: var(--primary-color);
            }
            .payment-method-item.active {
                border-color: var(--primary-color);
                background-color: rgba(58, 134, 255, 0.05);
            }
            .payment-method-item .form-check-input {
                margin-top: 0.25rem;
            }
            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(255, 255, 255, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                visibility: hidden;
                opacity: 0;
                transition: visibility 0s, opacity 0.3s;
            }
            .loading-overlay.show {
                visibility: visible;
                opacity: 1;
            }
            .spinner-border {
                width: 3rem;
                height: 3rem;
            }
        </style>
    </th:block>
</head>
<body>
<main layout:fragment="content">
    <!-- 로딩 오버레이 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <section class="py-5">
        <div class="container">
            <h2 class="mb-4">주문/결제</h2>

            <div class="checkout-container">
                <form id="orderForm" th:action="@{/orders}" method="post">
                    <div class="row">
                        <div class="col-lg-8">
                            <!-- 주문 상품 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">주문 상품</h5>
                                </div>
                                <div class="card-body">
                                    <div class="order-item" th:each="item : ${orderItems}">
                                        <div class="row align-items-center">
                                            <div class="col-auto">
                                                <img th:src="${item.product.mainImage}" alt="상품 이미지"
                                                     class="img-thumbnail" style="width: 100px;">
                                            </div>
                                            <div class="col">
                                                <p class="text-muted small mb-1" th:text="${item.product.brand?.name}">브랜드</p>
                                                <h5 class="mb-1" th:text="${item.product.name}">상품명</h5>
                                                <p class="text-muted small mb-0" th:if="${item.productOption != null}"
                                                   th:text="${item.productOption}">옵션</p>
                                                <p class="text-muted small mb-0" th:text="${item.quantity + '개'}">수량</p>
                                            </div>
                                            <div class="col-auto text-end">
                                                <p class="mb-0 fw-bold" 
                                                   th:text="${#numbers.formatInteger(item.totalPrice, 0, 'COMMA') + '원'}">
                                                    가격
                                                </p>
                                                <p class="text-muted small mb-0" th:if="${item.product.originalPrice > item.product.price}">
                                                    <del th:text="${#numbers.formatInteger(item.product.originalPrice * item.quantity, 0, 'COMMA') + '원'}">
                                                        정가
                                                    </del>
                                                </p>
                                            </div>
                                        </div>
                                        <hr th:if="${!itemStat.last}">
                                    </div>
                                </div>
                            </div>

                            <!-- 주문자 정보 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">주문자 정보</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="orderName" class="form-label">이름</label>
                                            <input type="text" class="form-control" id="orderName" name="orderName"
                                                   th:value="${member.name}" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="orderPhone" class="form-label">연락처</label>
                                            <input type="tel" class="form-control" id="orderPhone" name="orderPhone"
                                                   th:value="${member.phone}" required>
                                        </div>
                                        <div class="col-12">
                                            <label for="orderEmail" class="form-label">이메일</label>
                                            <input type="email" class="form-control" id="orderEmail" name="orderEmail"
                                                   th:value="${member.email}" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 배송지 정보 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">배송지 정보</h5>
                                </div>
                                <div class="card-body">
                                    <!-- 배송지 선택 -->
                                    <div class="mb-3">
                                        <select class="form-select" id="deliveryAddress">
                                            <option value="">새로운 배송지</option>
                                            <option th:each="address : ${addresses}"
                                                    th:value="${address.id}"
                                                    th:text="${address.name + ' - ' + address.address}">
                                                배송지
                                            </option>
                                        </select>
                                    </div>

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="receiverName" class="form-label">받는 사람</label>
                                            <input type="text" class="form-control" id="receiverName" name="receiverName" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="receiverPhone" class="form-label">연락처</label>
                                            <input type="tel" class="form-control" id="receiverPhone" name="receiverPhone" required>
                                        </div>
                                        <div class="col-12">
                                            <label for="zipcode" class="form-label">우편번호</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="zipcode" name="zipcode" readonly required>
                                                <button type="button" class="btn btn-outline-secondary" onclick="searchAddress()">
                                                    주소 검색
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label for="address1" class="form-label">기본주소</label>
                                            <input type="text" class="form-control" id="address1" name="address1" readonly required>
                                        </div>
                                        <div class="col-12">
                                            <label for="address2" class="form-label">상세주소</label>
                                            <input type="text" class="form-control" id="address2" name="address2" required>
                                        </div>
                                        <div class="col-12">
                                            <label for="deliveryRequest" class="form-label">배송 요청사항</label>
                                            <select class="form-select" id="deliveryRequest" name="deliveryRequest">
                                                <option value="">배송 시 요청사항을 선택해주세요</option>
                                                <option value="door">문 앞에 놓아주세요</option>
                                                <option value="security">경비실에 맡겨주세요</option>
                                                <option value="call">배송 전에 연락주세요</option>
                                                <option value="direct">직접 입력</option>
                                            </select>
                                            <input type="text" class="form-control mt-2" id="customRequest" 
                                                   name="customRequest" style="display: none;"
                                                   placeholder="배송 요청사항을 입력해주세요">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 결제 수단 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">결제 수단</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="paymentMethod"
                                                       id="card" value="card" checked>
                                                <label class="form-check-label" for="card">
                                                    신용카드
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="paymentMethod"
                                                       id="transfer" value="transfer">
                                                <label class="form-check-label" for="transfer">
                                                    실시간 계좌이체
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="paymentMethod"
                                                       id="vbank" value="vbank">
                                                <label class="form-check-label" for="vbank">
                                                    가상계좌
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <!-- 결제 금액 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">결제 금액</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>상품 금액</span>
                                        <span th:text="${#numbers.formatInteger(totalPrice, 0, 'COMMA') + '원'}">0원</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>할인 금액</span>
                                        <span class="text-danger" 
                                              th:text="${'-' + #numbers.formatInteger(totalDiscount, 0, 'COMMA') + '원'}">0원</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>배송비</span>
                                        <span th:text="${#numbers.formatInteger(shippingFee, 0, 'COMMA') + '원'}">0원</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-bold">최종 결제 금액</span>
                                        <span class="fw-bold" 
                                              th:text="${#numbers.formatInteger(finalAmount, 0, 'COMMA') + '원'}">0원</span>
                                    </div>
                                    <div class="text-end text-muted small">
                                        <span>적립 예정 포인트: </span>
                                        <span th:text="${#numbers.formatInteger(expectedPoints, 0, 'COMMA') + 'P'}">0P</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 포인트/쿠폰 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">포인트/쿠폰</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="coupon" class="form-label">쿠폰 적용</label>
                                        <select class="form-select" id="coupon" name="couponId">
                                            <option value="">사용 가능한 쿠폰 선택</option>
                                            <option th:each="coupon : ${availableCoupons}"
                                                    th:value="${coupon.id}"
                                                    th:text="${coupon.name + ' (' + coupon.discountAmount + '원 할인)'}">
                                                쿠폰
                                            </option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="points" class="form-label">
                                            포인트 사용 (보유: <span th:text="${#numbers.formatInteger(member.points, 0, 'COMMA')}">0</span>P)
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="points" name="usePoints"
                                                   min="0" th:max="${member.points}" value="0">
                                            <button class="btn btn-outline-secondary" type="button" onclick="useAllPoints()">
                                                전액 사용
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 결제하기 -->
                            <div class="card">
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="agreement" required>
                                        <label class="form-check-label" for="agreement">
                                            주문 내용을 확인하였으며, 결제에 동의합니다
                                        </label>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100" id="paymentButton">
                                        결제하기
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
</main>

<th:block layout:fragment="script">
    <script th:src="@{/js/checkout.js}"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script th:inline="javascript">
        $(document).ready(function() {
            // 배송지 선택
            $('#deliveryAddress').change(function() {
                const addressId = $(this).val();
                if (!addressId) {
                    clearAddressForm();
                    return;
                }

                $.get('/api/addresses/' + addressId)
                    .done(function(address) {
                        $('#receiverName').val(address.receiverName);
                        $('#receiverPhone').val(address.receiverPhone);
                        $('#zipcode').val(address.zipcode);
                        $('#address1').val(address.address1);
                        $('#address2').val(address.address2);
                    });
            });

            // 배송 요청사항
            $('#deliveryRequest').change(function() {
                const value = $(this).val();
                if (value === 'direct') {
                    $('#customRequest').show();
                } else {
                    $('#customRequest').hide().val('');
                }
            });

            // 포인트/쿠폰 적용
            $('#coupon, #points').change(function() {
                updatePaymentAmount();
            });

            // 결제하기
            $('#orderForm').submit(function(e) {
                e.preventDefault();
                
                if (!$('#agreement').prop('checked')) {
                    alert('주문 내용 확인 및 결제 동의가 필요합니다.');
                    return;
                }

                const formData = new FormData(this);
                
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        // 결제 모듈 호출
                        requestPayment(response);
                    },
                    error: function(xhr, status, error) {
                        alert('주문 처리에 실패했습니다. 다시 시도해주세요.');
                    }
                });
            });
        });

        // 주소 검색
        function searchAddress() {
            new daum.Postcode({
                oncomplete: function(data) {
                    $('#zipcode').val(data.zonecode);
                    $('#address1').val(data.address);
                    $('#address2').focus();
                }
            }).open();
        }

        // 배송지 폼 초기화
        function clearAddressForm() {
            $('#receiverName').val('');
            $('#receiverPhone').val('');
            $('#zipcode').val('');
            $('#address1').val('');
            $('#address2').val('');
        }

        // 포인트 전액 사용
        function useAllPoints() {
            const maxPoints = /*[[${member.points}]]*/ 0;
            $('#points').val(maxPoints);
            updatePaymentAmount();
        }

        // 결제 금액 업데이트
        function updatePaymentAmount() {
            const couponId = $('#coupon').val();
            const points = parseInt($('#points').val()) || 0;

            $.get('/api/orders/calculate', {
                orderItems: /*[[${orderItemIds}]]*/ [],
                couponId: couponId,
                usePoints: points
            }).done(function(response) {
                // 금액 업데이트 로직
            });
        }

        // 결제 요청
        function requestPayment(order) {
            // 결제 모듈 연동 로직
        }
    </script>
</th:block>
</body>
</html>

