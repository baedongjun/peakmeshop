<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop-layout}">
<head>
    <title>주문/결제 - PeakMeShop</title>
    <link rel="stylesheet" th:href="@{/css/components.css}">
</head>
<body>
<main layout:fragment="content">
    <div class="container py-5">
        <h1 class="h3 mb-4">주문/결제</h1>

        <form id="orderForm" th:action="@{/order/place}" method="post">
            <div class="row g-4">
                <!-- 주문 정보 -->
                <div class="col-lg-8">
                    <!-- 배송지 정보 -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2 class="h5 mb-0">배송지 정보</h2>
                                <button type="button" class="btn btn-sm btn-custom-outline" onclick="loadSavedAddresses()">
                                    배송지 목록
                                </button>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">받는 사람</label>
                                    <input type="text" class="form-control" name="receiverName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">연락처</label>
                                    <input type="tel" class="form-control" name="receiverPhone" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">주소</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" name="zipCode" readonly required>
                                        <button type="button" class="btn btn-custom-outline" onclick="searchAddress()">
                                            주소 검색
                                        </button>
                                    </div>
                                    <input type="text" class="form-control mb-2" name="address1" readonly required>
                                    <input type="text" class="form-control" name="address2" placeholder="상세주소" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">배송 요청사항</label>
                                    <select class="form-select mb-2" onchange="handleDeliveryRequest(this)">
                                        <option value="">배송 요청사항을 선택해주세요</option>
                                        <option value="door">문 앞에 놓아주세요</option>
                                        <option value="security">경비실에 맡겨주세요</option>
                                        <option value="call">배송 전에 연락주세요</option>
                                        <option value="custom">직접 입력</option>
                                    </select>
                                    <textarea class="form-control" name="deliveryRequest" rows="2" 
                                              style="display: none;"></textarea>
                                </div>
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="saveAddress" id="saveAddress">
                                        <label class="form-check-label" for="saveAddress">
                                            기본 배송지로 저장
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 주문 상품 -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h2 class="h5 mb-4">주문 상품</h2>
                            <div class="order-items">
                                <div th:each="item : ${orderItems}" class="order-item border-bottom py-3">
                                    <div class="d-flex gap-3">
                                        <div class="order-item-image">
                                            <img th:src="${item.product.mainImage}" 
                                                 class="rounded" 
                                                 style="width: 80px; height: 80px; object-fit: cover;"
                                                 th:alt="${item.product.name}">
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <a th:href="@{'/brands/' + ${item.product.brand.id}}" 
                                                       class="text-decoration-none text-muted small">
                                                        [[${item.product.brand.name}]]
                                                    </a>
                                                    <h3 class="h6 mb-1">
                                                        <a th:href="@{'/products/' + ${item.product.id}}" 
                                                           class="text-decoration-none text-dark">
                                                            [[${item.product.name}]]
                                                        </a>
                                                    </h3>
                                                    <div class="text-muted small" th:if="${not #lists.isEmpty(item.options)}">
                                                        <th:block th:each="option, stat : ${item.options}">
                                                            [[${option.name}]]: [[${option.value}]]
                                                            <span th:unless="${stat.last}">, </span>
                                                        </th:block>
                                                    </div>
                                                </div>
                                                <div class="text-end">
                                                    <div class="price-display">
                                                        <span th:if="${item.product.salePrice != null}" 
                                                              class="original-price" 
                                                              th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 0, 'POINT') + '원'}">
                                                        </span>
                                                        <span class="sale-price" 
                                                              th:text="${#numbers.formatDecimal(item.product.salePrice != null ? item.product.salePrice : item.product.price, 0, 'COMMA', 0, 'POINT') + '원'}">
                                                        </span>
                                                    </div>
                                                    <div class="text-muted small">
                                                        [[${item.quantity}]]개
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 할인 적용 -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h2 class="h5 mb-4">할인 적용</h2>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">쿠폰</label>
                                    <div class="input-group">
                                        <select class="form-select" name="couponId">
                                            <option value="">사용 가능한 쿠폰 선택</option>
                                            <option th:each="coupon : ${availableCoupons}"
                                                    th:value="${coupon.id}"
                                                    th:text="${coupon.name + ' (' + coupon.discountRate + '% 할인)'}">
                                            </option>
                                        </select>
                                        <button type="button" class="btn btn-custom-outline" onclick="applyCoupon()">
                                            적용
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">포인트</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="usePoints" 
                                               th:max="${availablePoints}" min="0" value="0">
                                        <button type="button" class="btn btn-custom-outline" onclick="applyPoints()">
                                            적용
                                        </button>
                                    </div>
                                    <div class="text-muted small mt-1">
                                        사용 가능한 포인트: [[${#numbers.formatInteger(availablePoints, 0, 'COMMA')}]]P
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 결제 수단 -->
                    <div class="card">
                        <div class="card-body">
                            <h2 class="h5 mb-4">결제 수단</h2>
                            <div class="payment-methods">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           id="card" value="card" checked>
                                    <label class="form-check-label" for="card">
                                        <i class="fas fa-credit-card me-2"></i>신용/체크카드
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           id="transfer" value="transfer">
                                    <label class="form-check-label" for="transfer">
                                        <i class="fas fa-university me-2"></i>계좌이체
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           id="phone" value="phone">
                                    <label class="form-check-label" for="phone">
                                        <i class="fas fa-mobile-alt me-2"></i>휴대폰 결제
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           id="kakao" value="kakao">
                                    <label class="form-check-label" for="kakao">
                                        <i class="fas fa-comment me-2"></i>카카오페이
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 결제 금액 -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="h5 mb-4">결제 금액</h2>
                            <div class="d-flex justify-content-between mb-2">
                                <span>상품 금액</span>
                                <span class="fw-bold" th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT') + '원'}">
                                </span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>할인 금액</span>
                                <span class="text-danger fw-bold" id="totalDiscount"
                                      th:text="'-' + ${#numbers.formatDecimal(totalDiscount, 0, 'COMMA', 0, 'POINT') + '원'}">
                                </span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>배송비</span>
                                <span th:text="${deliveryFee > 0 ? #numbers.formatDecimal(deliveryFee, 0, 'COMMA', 0, 'POINT') + '원' : '무료'}">
                                </span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="fw-bold">최종 결제 금액</span>
                                <span class="fw-bold fs-5" id="finalAmount"
                                      th:text="${#numbers.formatDecimal(totalPrice - totalDiscount + deliveryFee, 0, 'COMMA', 0, 'POINT') + '원'}">
                                </span>
                            </div>
                            <div class="text-muted small mb-3">
                                <i class="fas fa-coins me-1"></i>
                                구매 시 [[${#numbers.formatInteger((totalPrice - totalDiscount) * 0.01, 0)}]]원 적립
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    주문 내용을 확인하였으며, 결제에 동의합니다
                                </label>
                            </div>
                            <button type="submit" class="btn btn-custom-primary w-100" onclick="submitOrder()">
                                결제하기
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</main>

<!-- 배송지 목록 모달 -->
<div class="modal fade" id="addressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">배송지 목록</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="address-list">
                    <!-- 배송지 목록이 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 토스트 메시지 컨테이너 -->
<div class="toast-container"></div>

<th:block layout:fragment="scripts">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script th:inline="javascript">
        // 주소 검색
        function searchAddress() {
            new daum.Postcode({
                oncomplete: function(data) {
                    document.querySelector('input[name="zipCode"]').value = data.zonecode;
                    document.querySelector('input[name="address1"]').value = data.address;
                    document.querySelector('input[name="address2"]').focus();
                }
            }).open();
        }

        // 배송 요청사항 처리
        function handleDeliveryRequest(select) {
            const textarea = document.querySelector('textarea[name="deliveryRequest"]');
            if (select.value === 'custom') {
                textarea.style.display = 'block';
                textarea.value = '';
                textarea.focus();
            } else {
                textarea.style.display = 'none';
                textarea.value = select.options[select.selectedIndex].text;
            }
        }

        // 저장된 배송지 목록 로드
        async function loadSavedAddresses() {
            try {
                const response = await fetch('/api/addresses');
                if (!response.ok) throw new Error('배송지 목록 로딩 실패');

                const addresses = await response.json();
                const addressList = document.querySelector('.address-list');
                addressList.innerHTML = '';

                addresses.forEach(address => {
                    const template = `
                        <div class="card mb-2">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">${address.receiverName}</h6>
                                        <p class="mb-1">${address.receiverPhone}</p>
                                        <p class="mb-0 text-muted small">
                                            [${address.zipCode}] ${address.address1} ${address.address2}
                                        </p>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-custom-outline"
                                            onclick="selectAddress(${JSON.stringify(address)})">
                                        선택
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    addressList.insertAdjacentHTML('beforeend', template);
                });

                const modal = new bootstrap.Modal(document.getElementById('addressModal'));
                modal.show();
            } catch (error) {
                showToast('배송지 목록을 불러오는데 실패했습니다.', 'error');
            }
        }

        // 배송지 선택
        function selectAddress(address) {
            document.querySelector('input[name="receiverName"]').value = address.receiverName;
            document.querySelector('input[name="receiverPhone"]').value = address.receiverPhone;
            document.querySelector('input[name="zipCode"]').value = address.zipCode;
            document.querySelector('input[name="address1"]').value = address.address1;
            document.querySelector('input[name="address2"]').value = address.address2;

            bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide();
        }

        // 쿠폰 적용
        async function applyCoupon() {
            const couponId = document.querySelector('select[name="couponId"]').value;
            if (!couponId) {
                showToast('쿠폰을 선택해주세요.', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/order/apply-coupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        couponId: couponId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    updateOrderSummary(data);
                    showToast('쿠폰이 적용되었습니다.');
                } else {
                    throw new Error('쿠폰 적용 실패');
                }
            } catch (error) {
                showToast('쿠폰 적용에 실패했습니다.', 'error');
            }
        }

        // 포인트 적용
        async function applyPoints() {
            const points = parseInt(document.querySelector('input[name="usePoints"]').value);
            const maxPoints = [[${availablePoints}]];

            if (points < 0 || points > maxPoints) {
                showToast('사용 가능한 포인트를 확인해주세요.', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/order/apply-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        points: points
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    updateOrderSummary(data);
                    showToast('포인트가 적용되었습니다.');
                } else {
                    throw new Error('포인트 적용 실패');
                }
            } catch (error) {
                showToast('포인트 적용에 실패했습니다.', 'error');
            }
        }

        // 주문 요약 업데이트
        function updateOrderSummary(data) {
            document.getElementById('totalDiscount').textContent = 
                '-' + numberFormat(data.totalDiscount) + '원';
            document.getElementById('finalAmount').textContent = 
                numberFormat(data.finalAmount) + '원';
        }

        // 주문 제출
        async function submitOrder(event) {
            event.preventDefault();

            if (!document.getElementById('agreeTerms').checked) {
                showToast('주문 내용 확인 및 결제 동의가 필요합니다.', 'warning');
                return;
            }

            const form = document.getElementById('orderForm');
            const formData = new FormData(form);

            try {
                const response = await fetch('/api/order/place', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    location.href = `/order/complete/${data.orderId}`;
                } else {
                    throw new Error('주문 처리 실패');
                }
            } catch (error) {
                showToast('주문 처리에 실패했습니다.', 'error');
            }
        }

        // 숫자 포맷
        function numberFormat(number) {
            return new Intl.NumberFormat('ko-KR').format(number);
        }

        // 토스트 메시지 표시
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.querySelector('.toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</th:block>
</body>
</html> 