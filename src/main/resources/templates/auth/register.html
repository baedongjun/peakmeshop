<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">
<head>
    <title>회원가입</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card auth-card">
                    <div class="card-body p-4 p-md-5">
                        <h2 class="text-center mb-4">회원가입</h2>

                        <!-- 소셜 회원가입 -->
                        <div class="social-login mb-4">
                            <p class="text-center mb-3">소셜 계정으로 간편 가입</p>
                            <div class="d-flex justify-content-center gap-3">
                                <a href="#" class="btn btn-outline-secondary social-btn">
                                    <i class="fab fa-google"></i>
                                </a>
                                <a href="#" class="btn btn-outline-secondary social-btn">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                <a href="#" class="btn btn-outline-secondary social-btn">
                                    <i class="fab fa-naver"></i> N
                                </a>
                                <a href="#" class="btn btn-outline-secondary social-btn">
                                    <i class="fab fa-kickstarter-k"></i>
                                </a>
                            </div>
                        </div>

                        <div class="separator">
                            <span>또는 이메일로 가입</span>
                        </div>

                        <!-- 회원가입 폼 -->
                        <form th:action="@{/auth/register}" method="post" th:object="${memberForm}" class="mt-4">
                            <div class="mb-3">
                                <label for="email" class="form-label">이메일</label>
                                <div class="input-group">
                                    <input type="email" class="form-control" id="email" th:field="*{email}" required>
                                    <button type="button" class="btn btn-outline-primary" id="emailCheck">중복확인</button>
                                </div>
                                <div class="form-text text-danger" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                            </div>
                            <div class="mb-3">
                                <label for="username" class="form-label">아이디</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="username" th:field="*{username}" required>
                                    <button type="button" class="btn btn-outline-primary" id="usernameCheck">중복확인</button>
                                </div>
                                <div class="form-text">영문, 숫자 조합 4-20자</div>
                                <div class="form-text text-danger" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">비밀번호</label>
                                <input type="password" class="form-control" id="password" th:field="*{password}" required>
                                <div class="form-text">영문, 숫자, 특수문자 조합 8-20자</div>
                                <div class="form-text text-danger" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
                            </div>
                            <div class="mb-3">
                                <label for="passwordConfirm" class="form-label">비밀번호 확인</label>
                                <input type="password" class="form-control" id="passwordConfirm" th:field="*{passwordConfirm}" required>
                                <div class="form-text text-danger" th:if="${#fields.hasErrors('passwordConfirm')}" th:errors="*{passwordConfirm}"></div>
                            </div>
                            <div class="mb-3">
                                <label for="name" class="form-label">이름</label>
                                <input type="text" class="form-control" id="name" th:field="*{name}" required>
                                <div class="form-text text-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">휴대폰 번호</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="phone" th:field="*{phone}" placeholder="'-' 없이 입력" required>
                                    <button type="button" class="btn btn-outline-primary" id="sendVerification">인증번호 발송</button>
                                </div>
                                <div class="form-text text-danger" th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}"></div>
                            </div>
                            <div class="mb-3" id="verificationCodeGroup" style="display: none;">
                                <label for="verificationCode" class="form-label">인증번호</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="verificationCode" placeholder="인증번호 6자리">
                                    <button type="button" class="btn btn-outline-primary" id="verifyCode">확인</button>
                                </div>
                                <div class="form-text">인증번호가 발송되었습니다. 3분 이내에 입력해주세요.</div>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="agreeTerms" name="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    <a th:href="@{/terms}" class="text-decoration-none" target="_blank">이용약관</a> 및
                                    <a th:href="@{/privacy}" class="text-decoration-none" target="_blank">개인정보처리방침</a>에 동의합니다.
                                </label>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="agreeMarketing" name="agreeMarketing">
                                <label class="form-check-label" for="agreeMarketing">
                                    마케팅 정보 수신에 동의합니다. (선택)
                                </label>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">회원가입</button>
                            </div>
                        </form>

                        <div class="text-center mt-4">
                            <p>이미 회원이신가요? <a th:href="@{/auth/login}" class="text-decoration-none">로그인</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        $(document).ready(function() {
            // 이메일 중복 확인
            $('#emailCheck').click(function() {
                const email = $('#email').val();
                if (!email) {
                    alert('이메일을 입력해주세요.');
                    return;
                }

                // AJAX 요청
                $.ajax({
                    url: '/api/check-email',
                    type: 'GET',
                    data: { email: email },
                    success: function(response) {
                        if (response.available) {
                            alert('사용 가능한 이메일입니다.');
                        } else {
                            alert('이미 사용 중인 이메일입니다.');
                        }
                    },
                    error: function() {
                        alert('서버 오류가 발생했습니다. 다시 시도해주세요.');
                    }
                });
            });

            // 아이디 중복 확인
            $('#usernameCheck').click(function() {
                const username = $('#username').val();
                if (!username) {
                    alert('아이디를 입력해주세요.');
                    return;
                }

                // AJAX 요청
                $.ajax({
                    url: '/api/check-username',
                    type: 'GET',
                    data: { username: username },
                    success: function(response) {
                        if (response.available) {
                            alert('사용 가능한 아이디입니다.');
                        } else {
                            alert('이미 사용 중인 아이디입니다.');
                        }
                    },
                    error: function() {
                        alert('서버 오류가 발생했습니다. 다시 시도해주세요.');
                    }
                });
            });

            // 인증번호 발송
            $('#sendVerification').click(function() {
                const phone = $('#phone').val();
                if (!phone) {
                    alert('휴대폰 번호를 입력해주세요.');
                    return;
                }

                // AJAX 요청
                $.ajax({
                    url: '/api/send-verification',
                    type: 'POST',
                    data: { phone: phone },
                    success: function(response) {
                        if (response.success) {
                            $('#verificationCodeGroup').show();
                        } else {
                            alert('인증번호 발송에 실패했습니다. 다시 시도해주세요.');
                        }
                    },
                    error: function() {
                        alert('서버 오류가 발생했습니다. 다시 시도해주세요.');
                    }
                });
            });

            // 인증번호 확인
            $('#verifyCode').click(function() {
                const phone = $('#phone').val();
                const code = $('#verificationCode').val();
                if (!code) {
                    alert('인증번호를 입력해주세요.');
                    return;
                }

                // AJAX 요청
                $.ajax({
                    url: '/api/verify-code',
                    type: 'POST',
                    data: { phone: phone, code: code },
                    success: function(response) {
                        if (response.verified) {
                            alert('인증이 완료되었습니다.');
                            $('#phone').prop('readonly', true);
                            $('#sendVerification').prop('disabled', true);
                            $('#verificationCode').prop('readonly', true);
                            $('#verifyCode').prop('disabled', true);
                        } else {
                            alert('인증번호가 일치하지 않습니다. 다시 확인해주세요.');
                        }
                    },
                    error: function() {
                        alert('서버 오류가 발생했습니다. 다시 시도해주세요.');
                    }
                });
            });
        });
    </script>
</th:block>
</body>
</html>